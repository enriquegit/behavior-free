<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 9 Multi-user Validation | Behavior Analysis with Machine Learning Using R</title>
  <meta name="description" content="Chapter 9 Multi-user Validation | Behavior Analysis with Machine Learning Using R teaches you how to train machine learning models in the R programming language to make sense of behavioral data collected with sensors and stored in electronic records. This book introduces machine learning concepts and algorithms applied to a diverse set of behavior analysis problems by focusing on practical aspects. Some of the topics include how to: Build supervised models to predict indoor locations based on Wi-Fi signals, recognize physical activities from smartphone sensors, use unsupervised learning to discover criminal behavioral patterns, build deep learning models to analyze electromyography signals, CNNs to detect smiles in images and much more." />
  <meta name="generator" content="bookdown 0.22 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 9 Multi-user Validation | Behavior Analysis with Machine Learning Using R" />
  <meta property="og:type" content="book" />
  
  <meta property="og:image" content="/images/cover.png" />
  <meta property="og:description" content="Chapter 9 Multi-user Validation | Behavior Analysis with Machine Learning Using R teaches you how to train machine learning models in the R programming language to make sense of behavioral data collected with sensors and stored in electronic records. This book introduces machine learning concepts and algorithms applied to a diverse set of behavior analysis problems by focusing on practical aspects. Some of the topics include how to: Build supervised models to predict indoor locations based on Wi-Fi signals, recognize physical activities from smartphone sensors, use unsupervised learning to discover criminal behavioral patterns, build deep learning models to analyze electromyography signals, CNNs to detect smiles in images and much more." />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 9 Multi-user Validation | Behavior Analysis with Machine Learning Using R" />
  
  <meta name="twitter:description" content="Chapter 9 Multi-user Validation | Behavior Analysis with Machine Learning Using R teaches you how to train machine learning models in the R programming language to make sense of behavioral data collected with sensors and stored in electronic records. This book introduces machine learning concepts and algorithms applied to a diverse set of behavior analysis problems by focusing on practical aspects. Some of the topics include how to: Build supervised models to predict indoor locations based on Wi-Fi signals, recognize physical activities from smartphone sensors, use unsupervised learning to discover criminal behavioral patterns, build deep learning models to analyze electromyography signals, CNNs to detect smiles in images and much more." />
  <meta name="twitter:image" content="/images/cover.png" />

<meta name="author" content="Enrique Garcia Ceja" />


<meta name="date" content="2022-12-22" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="deeplearning.html"/>
<link rel="next" href="abnormalbehaviors.html"/>
<script src="libs/header-attrs/header-attrs.js"></script>
<script src="libs/jquery/jquery.min.js"></script>
<link href="libs/gitbook/css/style.css" rel="stylesheet" />
<link href="libs/gitbook/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook/css/plugin-clipboard.css" rel="stylesheet" />









<link href="libs/anchor-sections/anchor-sections.css" rel="stylesheet" />
<script src="libs/anchor-sections/anchor-sections.js"></script>
<script src="libs/htmlwidgets/htmlwidgets.js"></script>
<script src="libs/d3/d3.min.js"></script>
<link href="libs/d3panels/d3panels.min.css" rel="stylesheet" />
<script src="libs/d3panels/d3panels.min.js"></script>
<script src="libs/qtlcharts_iplotCorr/iplotCorr.js"></script>
<script src="libs/qtlcharts_iplotCorr/iplotCorr_noscat.js"></script>
<script src="libs/iplotCorr-binding/iplotCorr.js"></script>
<link href="libs/dygraphs/dygraph.css" rel="stylesheet" />
<script src="libs/dygraphs/dygraph-combined.js"></script>
<script src="libs/dygraphs/shapes.js"></script>
<script src="libs/moment/moment.js"></script>
<script src="libs/moment-timezone/moment-timezone-with-data.js"></script>
<script src="libs/moment-fquarter/moment-fquarter.min.js"></script>
<script src="libs/dygraphs-binding/dygraphs.js"></script>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-178679335-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-178679335-1', { 'anonymize_ip': true });
</script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
/* Used with Pandoc 2.11+ new --citeproc when CSL is used */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>

<link rel="stylesheet" href="css/style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="#">Behavior Analysis with Machine Learning Using R</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Welcome</a>
<ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#about-the-front-cover"><i class="fa fa-check"></i>About the Front Cover</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#about-the-author"><i class="fa fa-check"></i>About the Author</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="preface.html"><a href="preface.html"><i class="fa fa-check"></i>Preface</a>
<ul>
<li class="chapter" data-level="" data-path="preface.html"><a href="preface.html#supplemental-material"><i class="fa fa-check"></i>Supplemental Material</a></li>
<li class="chapter" data-level="" data-path="preface.html"><a href="preface.html#conventions"><i class="fa fa-check"></i>Conventions</a></li>
<li class="chapter" data-level="" data-path="preface.html"><a href="preface.html#acknowledgments"><i class="fa fa-check"></i>Acknowledgments</a></li>
</ul></li>
<li class="chapter" data-level="1" data-path="intro.html"><a href="intro.html"><i class="fa fa-check"></i><b>1</b> Introduction to Behavior and Machine Learning</a>
<ul>
<li class="chapter" data-level="1.1" data-path="intro.html"><a href="intro.html#what-is-behavior"><i class="fa fa-check"></i><b>1.1</b> What Is Behavior?</a></li>
<li class="chapter" data-level="1.2" data-path="intro.html"><a href="intro.html#what-is-machine-learning"><i class="fa fa-check"></i><b>1.2</b> What Is Machine Learning?</a></li>
<li class="chapter" data-level="1.3" data-path="intro.html"><a href="intro.html#taxonomy"><i class="fa fa-check"></i><b>1.3</b> Types of Machine Learning</a></li>
<li class="chapter" data-level="1.4" data-path="intro.html"><a href="intro.html#terminology"><i class="fa fa-check"></i><b>1.4</b> Terminology</a>
<ul>
<li class="chapter" data-level="1.4.1" data-path="intro.html"><a href="intro.html#tables"><i class="fa fa-check"></i><b>1.4.1</b> Tables</a></li>
<li class="chapter" data-level="1.4.2" data-path="intro.html"><a href="intro.html#variable-types"><i class="fa fa-check"></i><b>1.4.2</b> Variable Types</a></li>
<li class="chapter" data-level="1.4.3" data-path="intro.html"><a href="intro.html#predictive-models"><i class="fa fa-check"></i><b>1.4.3</b> Predictive Models</a></li>
</ul></li>
<li class="chapter" data-level="1.5" data-path="intro.html"><a href="intro.html#pipeline"><i class="fa fa-check"></i><b>1.5</b> Data Analysis Pipeline</a></li>
<li class="chapter" data-level="1.6" data-path="intro.html"><a href="intro.html#trainingeval"><i class="fa fa-check"></i><b>1.6</b> Evaluating Predictive Models</a></li>
<li class="chapter" data-level="1.7" data-path="intro.html"><a href="intro.html#simple-classification-example"><i class="fa fa-check"></i><b>1.7</b> Simple Classification Example</a>
<ul>
<li class="chapter" data-level="1.7.1" data-path="intro.html"><a href="intro.html#k-fold-cross-validation-example"><i class="fa fa-check"></i><b>1.7.1</b> <span class="math inline">\(k\)</span>-fold Cross-validation Example</a></li>
</ul></li>
<li class="chapter" data-level="1.8" data-path="intro.html"><a href="intro.html#simple-regression-example"><i class="fa fa-check"></i><b>1.8</b> Simple Regression Example</a></li>
<li class="chapter" data-level="1.9" data-path="intro.html"><a href="intro.html#underfitting-and-overfitting"><i class="fa fa-check"></i><b>1.9</b> Underfitting and Overfitting</a></li>
<li class="chapter" data-level="1.10" data-path="intro.html"><a href="intro.html#bias-and-variance"><i class="fa fa-check"></i><b>1.10</b> Bias and Variance</a></li>
<li class="chapter" data-level="1.11" data-path="intro.html"><a href="intro.html#SummaryIntro"><i class="fa fa-check"></i><b>1.11</b> Summary</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="classification.html"><a href="classification.html"><i class="fa fa-check"></i><b>2</b> Predicting Behavior with Classification Models</a>
<ul>
<li class="chapter" data-level="2.1" data-path="classification.html"><a href="classification.html#k-nearest-neighbors"><i class="fa fa-check"></i><b>2.1</b> <em>k</em>-Nearest Neighbors</a>
<ul>
<li class="chapter" data-level="2.1.1" data-path="classification.html"><a href="classification.html#indoor-location-with-wi-fi-signals"><i class="fa fa-check"></i><b>2.1.1</b> Indoor Location with Wi-Fi Signals</a></li>
</ul></li>
<li class="chapter" data-level="2.2" data-path="classification.html"><a href="classification.html#performance-metrics"><i class="fa fa-check"></i><b>2.2</b> Performance Metrics</a>
<ul>
<li class="chapter" data-level="2.2.1" data-path="classification.html"><a href="classification.html#confusion-matrix"><i class="fa fa-check"></i><b>2.2.1</b> Confusion Matrix</a></li>
</ul></li>
<li class="chapter" data-level="2.3" data-path="classification.html"><a href="classification.html#decision-trees"><i class="fa fa-check"></i><b>2.3</b> Decision Trees</a>
<ul>
<li class="chapter" data-level="2.3.1" data-path="classification.html"><a href="classification.html#activityRecognition"><i class="fa fa-check"></i><b>2.3.1</b> Activity Recognition with Smartphones</a></li>
</ul></li>
<li class="chapter" data-level="2.4" data-path="classification.html"><a href="classification.html#naive-bayes"><i class="fa fa-check"></i><b>2.4</b> Naive Bayes</a>
<ul>
<li class="chapter" data-level="2.4.1" data-path="classification.html"><a href="classification.html#activity-recognition-with-naive-bayes"><i class="fa fa-check"></i><b>2.4.1</b> Activity Recognition with Naive Bayes</a></li>
</ul></li>
<li class="chapter" data-level="2.5" data-path="classification.html"><a href="classification.html#dynamic-time-warping"><i class="fa fa-check"></i><b>2.5</b> Dynamic Time Warping</a>
<ul>
<li class="chapter" data-level="2.5.1" data-path="classification.html"><a href="classification.html#sechandgestures"><i class="fa fa-check"></i><b>2.5.1</b> Hand Gesture Recognition</a></li>
</ul></li>
<li class="chapter" data-level="2.6" data-path="classification.html"><a href="classification.html#dummy-models"><i class="fa fa-check"></i><b>2.6</b> Dummy Models</a>
<ul>
<li class="chapter" data-level="2.6.1" data-path="classification.html"><a href="classification.html#most-frequent-class-classifier"><i class="fa fa-check"></i><b>2.6.1</b> Most-frequent-class Classifier</a></li>
<li class="chapter" data-level="2.6.2" data-path="classification.html"><a href="classification.html#uniform-classifier"><i class="fa fa-check"></i><b>2.6.2</b> Uniform Classifier</a></li>
<li class="chapter" data-level="2.6.3" data-path="classification.html"><a href="classification.html#frequency-based-classifier"><i class="fa fa-check"></i><b>2.6.3</b> Frequency-based Classifier</a></li>
<li class="chapter" data-level="2.6.4" data-path="classification.html"><a href="classification.html#other-dummy-classifiers"><i class="fa fa-check"></i><b>2.6.4</b> Other Dummy Classifiers</a></li>
</ul></li>
<li class="chapter" data-level="2.7" data-path="classification.html"><a href="classification.html#summaryClassification"><i class="fa fa-check"></i><b>2.7</b> Summary</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="ensemble.html"><a href="ensemble.html"><i class="fa fa-check"></i><b>3</b> Predicting Behavior with Ensemble Learning</a>
<ul>
<li class="chapter" data-level="3.1" data-path="ensemble.html"><a href="ensemble.html#bagging"><i class="fa fa-check"></i><b>3.1</b> Bagging</a>
<ul>
<li class="chapter" data-level="3.1.1" data-path="ensemble.html"><a href="ensemble.html#activity-recognition-with-bagging"><i class="fa fa-check"></i><b>3.1.1</b> Activity Recognition with Bagging</a></li>
</ul></li>
<li class="chapter" data-level="3.2" data-path="ensemble.html"><a href="ensemble.html#random-forest"><i class="fa fa-check"></i><b>3.2</b> Random Forest</a></li>
<li class="chapter" data-level="3.3" data-path="ensemble.html"><a href="ensemble.html#stacked-generalization"><i class="fa fa-check"></i><b>3.3</b> Stacked Generalization</a></li>
<li class="chapter" data-level="3.4" data-path="ensemble.html"><a href="ensemble.html#multiviewhometasks"><i class="fa fa-check"></i><b>3.4</b> Multi-view Stacking for Home Tasks Recognition</a></li>
<li class="chapter" data-level="3.5" data-path="ensemble.html"><a href="ensemble.html#SummaryEnsemble"><i class="fa fa-check"></i><b>3.5</b> Summary</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="edavis.html"><a href="edavis.html"><i class="fa fa-check"></i><b>4</b> Exploring and Visualizing Behavioral Data</a>
<ul>
<li class="chapter" data-level="4.1" data-path="edavis.html"><a href="edavis.html#talking-with-field-experts"><i class="fa fa-check"></i><b>4.1</b> Talking with Field Experts</a></li>
<li class="chapter" data-level="4.2" data-path="edavis.html"><a href="edavis.html#summary-statistics"><i class="fa fa-check"></i><b>4.2</b> Summary Statistics</a></li>
<li class="chapter" data-level="4.3" data-path="edavis.html"><a href="edavis.html#class-distributions"><i class="fa fa-check"></i><b>4.3</b> Class Distributions</a></li>
<li class="chapter" data-level="4.4" data-path="edavis.html"><a href="edavis.html#user-class-sparsity-matrix"><i class="fa fa-check"></i><b>4.4</b> User-class Sparsity Matrix</a></li>
<li class="chapter" data-level="4.5" data-path="edavis.html"><a href="edavis.html#boxplots"><i class="fa fa-check"></i><b>4.5</b> Boxplots</a></li>
<li class="chapter" data-level="4.6" data-path="edavis.html"><a href="edavis.html#correlation-plots"><i class="fa fa-check"></i><b>4.6</b> Correlation Plots</a>
<ul>
<li class="chapter" data-level="4.6.1" data-path="edavis.html"><a href="edavis.html#interactive-correlation-plots"><i class="fa fa-check"></i><b>4.6.1</b> Interactive Correlation Plots</a></li>
</ul></li>
<li class="chapter" data-level="4.7" data-path="edavis.html"><a href="edavis.html#timeseries"><i class="fa fa-check"></i><b>4.7</b> Timeseries</a>
<ul>
<li class="chapter" data-level="4.7.1" data-path="edavis.html"><a href="edavis.html#interactive-timeseries"><i class="fa fa-check"></i><b>4.7.1</b> Interactive Timeseries</a></li>
</ul></li>
<li class="chapter" data-level="4.8" data-path="edavis.html"><a href="edavis.html#multidimensional-scaling-mds"><i class="fa fa-check"></i><b>4.8</b> Multidimensional Scaling (MDS)</a></li>
<li class="chapter" data-level="4.9" data-path="edavis.html"><a href="edavis.html#heatmaps"><i class="fa fa-check"></i><b>4.9</b> Heatmaps</a></li>
<li class="chapter" data-level="4.10" data-path="edavis.html"><a href="edavis.html#automated-eda"><i class="fa fa-check"></i><b>4.10</b> Automated EDA</a></li>
<li class="chapter" data-level="4.11" data-path="edavis.html"><a href="edavis.html#SummaryExploratory"><i class="fa fa-check"></i><b>4.11</b> Summary</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="preprocessing.html"><a href="preprocessing.html"><i class="fa fa-check"></i><b>5</b> Preprocessing Behavioral Data</a>
<ul>
<li class="chapter" data-level="5.1" data-path="preprocessing.html"><a href="preprocessing.html#missing-values"><i class="fa fa-check"></i><b>5.1</b> Missing Values</a>
<ul>
<li class="chapter" data-level="5.1.1" data-path="preprocessing.html"><a href="preprocessing.html#imputation"><i class="fa fa-check"></i><b>5.1.1</b> Imputation</a></li>
</ul></li>
<li class="chapter" data-level="5.2" data-path="preprocessing.html"><a href="preprocessing.html#smoothing"><i class="fa fa-check"></i><b>5.2</b> Smoothing</a></li>
<li class="chapter" data-level="5.3" data-path="preprocessing.html"><a href="preprocessing.html#normalization"><i class="fa fa-check"></i><b>5.3</b> Normalization</a></li>
<li class="chapter" data-level="5.4" data-path="preprocessing.html"><a href="preprocessing.html#imbalanced-classes"><i class="fa fa-check"></i><b>5.4</b> Imbalanced Classes</a>
<ul>
<li class="chapter" data-level="5.4.1" data-path="preprocessing.html"><a href="preprocessing.html#random-oversampling"><i class="fa fa-check"></i><b>5.4.1</b> Random Oversampling</a></li>
<li class="chapter" data-level="5.4.2" data-path="preprocessing.html"><a href="preprocessing.html#smote"><i class="fa fa-check"></i><b>5.4.2</b> SMOTE</a></li>
</ul></li>
<li class="chapter" data-level="5.5" data-path="preprocessing.html"><a href="preprocessing.html#infoinjection"><i class="fa fa-check"></i><b>5.5</b> Information Injection</a></li>
<li class="chapter" data-level="5.6" data-path="preprocessing.html"><a href="preprocessing.html#one-hot-encoding"><i class="fa fa-check"></i><b>5.6</b> One-hot Encoding</a></li>
<li class="chapter" data-level="5.7" data-path="preprocessing.html"><a href="preprocessing.html#SummaryPreprocessing"><i class="fa fa-check"></i><b>5.7</b> Summary</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="unsupervised.html"><a href="unsupervised.html"><i class="fa fa-check"></i><b>6</b> Discovering Behaviors with Unsupervised Learning</a>
<ul>
<li class="chapter" data-level="6.1" data-path="unsupervised.html"><a href="unsupervised.html#k-means-clustering"><i class="fa fa-check"></i><b>6.1</b> <span class="math inline">\(k\)</span>-means Clustering</a>
<ul>
<li class="chapter" data-level="6.1.1" data-path="unsupervised.html"><a href="unsupervised.html#studentresponses"><i class="fa fa-check"></i><b>6.1.1</b> Grouping Student Responses</a></li>
</ul></li>
<li class="chapter" data-level="6.2" data-path="unsupervised.html"><a href="unsupervised.html#the-silhouette-index"><i class="fa fa-check"></i><b>6.2</b> The Silhouette Index</a></li>
<li class="chapter" data-level="6.3" data-path="unsupervised.html"><a href="unsupervised.html#associationrules"><i class="fa fa-check"></i><b>6.3</b> Mining Association Rules</a>
<ul>
<li class="chapter" data-level="6.3.1" data-path="unsupervised.html"><a href="unsupervised.html#finding-rules-for-criminal-behavior"><i class="fa fa-check"></i><b>6.3.1</b> Finding Rules for Criminal Behavior</a></li>
</ul></li>
<li class="chapter" data-level="6.4" data-path="unsupervised.html"><a href="unsupervised.html#SummaryUnsupervised"><i class="fa fa-check"></i><b>6.4</b> Summary</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="representations.html"><a href="representations.html"><i class="fa fa-check"></i><b>7</b> Encoding Behavioral Data</a>
<ul>
<li class="chapter" data-level="7.1" data-path="representations.html"><a href="representations.html#feature-vectors"><i class="fa fa-check"></i><b>7.1</b> Feature Vectors</a></li>
<li class="chapter" data-level="7.2" data-path="representations.html"><a href="representations.html#sectimeseries"><i class="fa fa-check"></i><b>7.2</b> Timeseries</a></li>
<li class="chapter" data-level="7.3" data-path="representations.html"><a href="representations.html#transactions"><i class="fa fa-check"></i><b>7.3</b> Transactions</a></li>
<li class="chapter" data-level="7.4" data-path="representations.html"><a href="representations.html#images"><i class="fa fa-check"></i><b>7.4</b> Images</a></li>
<li class="chapter" data-level="7.5" data-path="representations.html"><a href="representations.html#recurrence-plots"><i class="fa fa-check"></i><b>7.5</b> Recurrence Plots</a>
<ul>
<li class="chapter" data-level="7.5.1" data-path="representations.html"><a href="representations.html#computing-recurrence-plots"><i class="fa fa-check"></i><b>7.5.1</b> Computing Recurrence Plots</a></li>
<li class="chapter" data-level="7.5.2" data-path="representations.html"><a href="representations.html#recurrence-plots-of-hand-gestures"><i class="fa fa-check"></i><b>7.5.2</b> Recurrence Plots of Hand Gestures</a></li>
</ul></li>
<li class="chapter" data-level="7.6" data-path="representations.html"><a href="representations.html#bag-of-words"><i class="fa fa-check"></i><b>7.6</b> Bag-of-Words</a>
<ul>
<li class="chapter" data-level="7.6.1" data-path="representations.html"><a href="representations.html#bow-for-complex-activities."><i class="fa fa-check"></i><b>7.6.1</b> BoW for Complex Activities.</a></li>
</ul></li>
<li class="chapter" data-level="7.7" data-path="representations.html"><a href="representations.html#graphs"><i class="fa fa-check"></i><b>7.7</b> Graphs</a>
<ul>
<li class="chapter" data-level="7.7.1" data-path="representations.html"><a href="representations.html#complex-activities-as-graphs"><i class="fa fa-check"></i><b>7.7.1</b> Complex Activities as Graphs</a></li>
</ul></li>
<li class="chapter" data-level="7.8" data-path="representations.html"><a href="representations.html#SummaryRepresentations"><i class="fa fa-check"></i><b>7.8</b> Summary</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="deeplearning.html"><a href="deeplearning.html"><i class="fa fa-check"></i><b>8</b> Predicting Behavior with Deep Learning</a>
<ul>
<li class="chapter" data-level="8.1" data-path="deeplearning.html"><a href="deeplearning.html#ann"><i class="fa fa-check"></i><b>8.1</b> Introduction to Artificial Neural Networks</a>
<ul>
<li class="chapter" data-level="8.1.1" data-path="deeplearning.html"><a href="deeplearning.html#sigmoid-and-relu-units"><i class="fa fa-check"></i><b>8.1.1</b> Sigmoid and ReLU Units</a></li>
<li class="chapter" data-level="8.1.2" data-path="deeplearning.html"><a href="deeplearning.html#assembling-units-into-layers"><i class="fa fa-check"></i><b>8.1.2</b> Assembling Units into Layers</a></li>
<li class="chapter" data-level="8.1.3" data-path="deeplearning.html"><a href="deeplearning.html#deep-neural-networks"><i class="fa fa-check"></i><b>8.1.3</b> Deep Neural Networks</a></li>
<li class="chapter" data-level="8.1.4" data-path="deeplearning.html"><a href="deeplearning.html#learning-the-parameters"><i class="fa fa-check"></i><b>8.1.4</b> Learning the Parameters</a></li>
<li class="chapter" data-level="8.1.5" data-path="deeplearning.html"><a href="deeplearning.html#parameter-learning-example-in-r"><i class="fa fa-check"></i><b>8.1.5</b> Parameter Learning Example in R</a></li>
<li class="chapter" data-level="8.1.6" data-path="deeplearning.html"><a href="deeplearning.html#stochastic-gradient-descent"><i class="fa fa-check"></i><b>8.1.6</b> Stochastic Gradient Descent</a></li>
</ul></li>
<li class="chapter" data-level="8.2" data-path="deeplearning.html"><a href="deeplearning.html#keras-and-tensorflow-with-r"><i class="fa fa-check"></i><b>8.2</b> Keras and TensorFlow with R</a>
<ul>
<li class="chapter" data-level="8.2.1" data-path="deeplearning.html"><a href="deeplearning.html#keras-example"><i class="fa fa-check"></i><b>8.2.1</b> Keras Example</a></li>
</ul></li>
<li class="chapter" data-level="8.3" data-path="deeplearning.html"><a href="deeplearning.html#classification-with-neural-networks"><i class="fa fa-check"></i><b>8.3</b> Classification with Neural Networks</a>
<ul>
<li class="chapter" data-level="8.3.1" data-path="deeplearning.html"><a href="deeplearning.html#classification-of-electromyography-signals"><i class="fa fa-check"></i><b>8.3.1</b> Classification of Electromyography Signals</a></li>
</ul></li>
<li class="chapter" data-level="8.4" data-path="deeplearning.html"><a href="deeplearning.html#overfitting"><i class="fa fa-check"></i><b>8.4</b> Overfitting</a>
<ul>
<li class="chapter" data-level="8.4.1" data-path="deeplearning.html"><a href="deeplearning.html#early-stopping"><i class="fa fa-check"></i><b>8.4.1</b> Early Stopping</a></li>
<li class="chapter" data-level="8.4.2" data-path="deeplearning.html"><a href="deeplearning.html#dropout"><i class="fa fa-check"></i><b>8.4.2</b> Dropout</a></li>
</ul></li>
<li class="chapter" data-level="8.5" data-path="deeplearning.html"><a href="deeplearning.html#fine-tuning-a-neural-network"><i class="fa fa-check"></i><b>8.5</b> Fine-tuning a Neural Network</a></li>
<li class="chapter" data-level="8.6" data-path="deeplearning.html"><a href="deeplearning.html#cnns"><i class="fa fa-check"></i><b>8.6</b> Convolutional Neural Networks</a>
<ul>
<li class="chapter" data-level="8.6.1" data-path="deeplearning.html"><a href="deeplearning.html#convolutions"><i class="fa fa-check"></i><b>8.6.1</b> Convolutions</a></li>
<li class="chapter" data-level="8.6.2" data-path="deeplearning.html"><a href="deeplearning.html#pooling-operations"><i class="fa fa-check"></i><b>8.6.2</b> Pooling Operations</a></li>
</ul></li>
<li class="chapter" data-level="8.7" data-path="deeplearning.html"><a href="deeplearning.html#cnns-with-keras"><i class="fa fa-check"></i><b>8.7</b> CNNs with Keras</a>
<ul>
<li class="chapter" data-level="8.7.1" data-path="deeplearning.html"><a href="deeplearning.html#example-1"><i class="fa fa-check"></i><b>8.7.1</b> Example 1</a></li>
<li class="chapter" data-level="8.7.2" data-path="deeplearning.html"><a href="deeplearning.html#example-2"><i class="fa fa-check"></i><b>8.7.2</b> Example 2</a></li>
</ul></li>
<li class="chapter" data-level="8.8" data-path="deeplearning.html"><a href="deeplearning.html#cnnSmile"><i class="fa fa-check"></i><b>8.8</b> Smiles Detection with a CNN</a></li>
<li class="chapter" data-level="8.9" data-path="deeplearning.html"><a href="deeplearning.html#SummaryDeepLearning"><i class="fa fa-check"></i><b>8.9</b> Summary</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="multiuser.html"><a href="multiuser.html"><i class="fa fa-check"></i><b>9</b> Multi-user Validation</a>
<ul>
<li class="chapter" data-level="9.1" data-path="multiuser.html"><a href="multiuser.html#mixed-models"><i class="fa fa-check"></i><b>9.1</b> Mixed Models</a>
<ul>
<li class="chapter" data-level="9.1.1" data-path="multiuser.html"><a href="multiuser.html#skeleton-action-recognition-with-mixed-models"><i class="fa fa-check"></i><b>9.1.1</b> Skeleton Action Recognition with Mixed Models</a></li>
</ul></li>
<li class="chapter" data-level="9.2" data-path="multiuser.html"><a href="multiuser.html#user-independent-models"><i class="fa fa-check"></i><b>9.2</b> User-independent Models</a></li>
<li class="chapter" data-level="9.3" data-path="multiuser.html"><a href="multiuser.html#user-dependent-models"><i class="fa fa-check"></i><b>9.3</b> User-dependent Models</a></li>
<li class="chapter" data-level="9.4" data-path="multiuser.html"><a href="multiuser.html#user-adaptive-models"><i class="fa fa-check"></i><b>9.4</b> User-adaptive Models</a>
<ul>
<li class="chapter" data-level="9.4.1" data-path="multiuser.html"><a href="multiuser.html#transfer-learning"><i class="fa fa-check"></i><b>9.4.1</b> Transfer Learning</a></li>
<li class="chapter" data-level="9.4.2" data-path="multiuser.html"><a href="multiuser.html#a-user-adaptive-model-for-activity-recognition"><i class="fa fa-check"></i><b>9.4.2</b> A User-adaptive Model for Activity Recognition</a></li>
</ul></li>
<li class="chapter" data-level="9.5" data-path="multiuser.html"><a href="multiuser.html#SummaryMultiUser"><i class="fa fa-check"></i><b>9.5</b> Summary</a></li>
</ul></li>
<li class="chapter" data-level="10" data-path="abnormalbehaviors.html"><a href="abnormalbehaviors.html"><i class="fa fa-check"></i><b>10</b> Detecting Abnormal Behaviors</a>
<ul>
<li class="chapter" data-level="10.1" data-path="abnormalbehaviors.html"><a href="abnormalbehaviors.html#isolation-forests"><i class="fa fa-check"></i><b>10.1</b> Isolation Forests</a></li>
<li class="chapter" data-level="10.2" data-path="abnormalbehaviors.html"><a href="abnormalbehaviors.html#detecting-abnormal-fish-behaviors"><i class="fa fa-check"></i><b>10.2</b> Detecting Abnormal Fish Behaviors</a>
<ul>
<li class="chapter" data-level="10.2.1" data-path="abnormalbehaviors.html"><a href="abnormalbehaviors.html#exploring-and-visualizing-trajectories"><i class="fa fa-check"></i><b>10.2.1</b> Exploring and Visualizing Trajectories</a></li>
<li class="chapter" data-level="10.2.2" data-path="abnormalbehaviors.html"><a href="abnormalbehaviors.html#preprocessing-and-feature-extraction"><i class="fa fa-check"></i><b>10.2.2</b> Preprocessing and Feature Extraction</a></li>
<li class="chapter" data-level="10.2.3" data-path="abnormalbehaviors.html"><a href="abnormalbehaviors.html#training-the-model"><i class="fa fa-check"></i><b>10.2.3</b> Training the Model</a></li>
<li class="chapter" data-level="10.2.4" data-path="abnormalbehaviors.html"><a href="abnormalbehaviors.html#roc-curve-and-auc"><i class="fa fa-check"></i><b>10.2.4</b> ROC Curve and AUC</a></li>
</ul></li>
<li class="chapter" data-level="10.3" data-path="abnormalbehaviors.html"><a href="abnormalbehaviors.html#autoencoders"><i class="fa fa-check"></i><b>10.3</b> Autoencoders</a>
<ul>
<li class="chapter" data-level="10.3.1" data-path="abnormalbehaviors.html"><a href="abnormalbehaviors.html#autoencoders-for-anomaly-detection"><i class="fa fa-check"></i><b>10.3.1</b> Autoencoders for Anomaly Detection</a></li>
</ul></li>
<li class="chapter" data-level="10.4" data-path="abnormalbehaviors.html"><a href="abnormalbehaviors.html#SummaryAnomalyDetection"><i class="fa fa-check"></i><b>10.4</b> Summary</a></li>
</ul></li>
<li class="appendix"><span><b>Appendix</b></span></li>
<li class="chapter" data-level="A" data-path="appendixInstall.html"><a href="appendixInstall.html"><i class="fa fa-check"></i><b>A</b> Setup Your Environment</a>
<ul>
<li class="chapter" data-level="A.1" data-path="appendixInstall.html"><a href="appendixInstall.html#installing-the-datasets"><i class="fa fa-check"></i><b>A.1</b> Installing the Datasets</a></li>
<li class="chapter" data-level="A.2" data-path="appendixInstall.html"><a href="appendixInstall.html#installing-the-examples-source-code"><i class="fa fa-check"></i><b>A.2</b> Installing the Examples Source Code</a></li>
<li class="chapter" data-level="A.3" data-path="appendixInstall.html"><a href="appendixInstall.html#running-shiny-apps"><i class="fa fa-check"></i><b>A.3</b> Running Shiny Apps</a></li>
<li class="chapter" data-level="A.4" data-path="appendixInstall.html"><a href="appendixInstall.html#installing-keras-and-tensorflow"><i class="fa fa-check"></i><b>A.4</b> Installing Keras and TensorFlow</a></li>
</ul></li>
<li class="chapter" data-level="B" data-path="appendixDatasets.html"><a href="appendixDatasets.html"><i class="fa fa-check"></i><b>B</b> Datasets</a>
<ul>
<li class="chapter" data-level="B.1" data-path="appendixDatasets.html"><a href="appendixDatasets.html#complex-activities"><i class="fa fa-check"></i><b>B.1</b> COMPLEX ACTIVITIES</a></li>
<li class="chapter" data-level="B.2" data-path="appendixDatasets.html"><a href="appendixDatasets.html#depresjon"><i class="fa fa-check"></i><b>B.2</b> DEPRESJON</a></li>
<li class="chapter" data-level="B.3" data-path="appendixDatasets.html"><a href="appendixDatasets.html#electromyography"><i class="fa fa-check"></i><b>B.3</b> ELECTROMYOGRAPHY</a></li>
<li class="chapter" data-level="B.4" data-path="appendixDatasets.html"><a href="appendixDatasets.html#fish-trajectories"><i class="fa fa-check"></i><b>B.4</b> FISH TRAJECTORIES</a></li>
<li class="chapter" data-level="B.5" data-path="appendixDatasets.html"><a href="appendixDatasets.html#hand-gestures"><i class="fa fa-check"></i><b>B.5</b> HAND GESTURES</a></li>
<li class="chapter" data-level="B.6" data-path="appendixDatasets.html"><a href="appendixDatasets.html#home-tasks"><i class="fa fa-check"></i><b>B.6</b> HOME TASKS</a></li>
<li class="chapter" data-level="B.7" data-path="appendixDatasets.html"><a href="appendixDatasets.html#homicide-reports"><i class="fa fa-check"></i><b>B.7</b> HOMICIDE REPORTS</a></li>
<li class="chapter" data-level="B.8" data-path="appendixDatasets.html"><a href="appendixDatasets.html#indoor-location"><i class="fa fa-check"></i><b>B.8</b> INDOOR LOCATION</a></li>
<li class="chapter" data-level="B.9" data-path="appendixDatasets.html"><a href="appendixDatasets.html#sheep-goats"><i class="fa fa-check"></i><b>B.9</b> SHEEP GOATS</a></li>
<li class="chapter" data-level="B.10" data-path="appendixDatasets.html"><a href="appendixDatasets.html#skeleton-actions"><i class="fa fa-check"></i><b>B.10</b> SKELETON ACTIONS</a></li>
<li class="chapter" data-level="B.11" data-path="appendixDatasets.html"><a href="appendixDatasets.html#smartphone-activities"><i class="fa fa-check"></i><b>B.11</b> SMARTPHONE ACTIVITIES</a></li>
<li class="chapter" data-level="B.12" data-path="appendixDatasets.html"><a href="appendixDatasets.html#smiles"><i class="fa fa-check"></i><b>B.12</b> SMILES</a></li>
<li class="chapter" data-level="B.13" data-path="appendixDatasets.html"><a href="appendixDatasets.html#students-mental-health"><i class="fa fa-check"></i><b>B.13</b> STUDENTS’ MENTAL HEALTH</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="citing-this-book.html"><a href="citing-this-book.html"><i class="fa fa-check"></i>Citing this Book</a></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Behavior Analysis with Machine Learning Using R</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="multiuser" class="section level1" number="9">
<h1><span class="header-section-number">Chapter 9</span> Multi-user Validation</h1>
<p>Every person is different. We all have different physical and mental characteristics. Every person reacts differently to the same stimulus and conducts physical and motor activities in particular ways. As we have seen, predictive models rely on the training data; and for user-oriented applications, this data encodes their behaviors. When building predictive models, we want them to be general and to perform accurately on new unseen instances. Sometimes this generalization capability comes at a price, especially in <strong>multi-user settings</strong>. A multi-user setting is one in which the results depend heavily on the <strong>target user</strong>, that is, the user on which the predictions are made. Take, for example, a hand gesture recognition system. At inference time, a specific person (the target user) performs a gesture and the system should recognize it. The input data comes directly from the user. On the other hand, a <strong>non multi-user</strong> system does not depend on a particular person. A classifier that labels fruits on images or a regression model that predicts house prices does not depend directly on a particular person.</p>
<p>Some time ago I had to build an activity recognition system based on inertial data from a wrist band. So I collected the data, trained the models, and evaluated them. The performance results were good. However, it turned out that when the system was tested on a new sample group it failed. The reason? The training data was collected from people within a particular age group (young) but the target market of the product was for much older people. Older people tend to walk more slowly, thus, the system was predicting <em>‘no movement’</em> when in fact, the person was walking at a very slow pace. This is an extreme example, but even within the same age groups, there can be differences between users (<em>inter-user variance</em>). Even the same user can evolve over time and change her/his behaviors (<em>intra-user variance</em>).</p>
<p>So, how do we evaluate multi-user systems to reduce the unexpected effects once the system is deployed? Most of the time, there’s going to be surprises when testing a system on new users. Nevertheless, in this chapter I will present three types of models that will help you reduce that uncertainty to some extent so you will have a better idea of how the system will behave when tested on more realistic conditions. The models are: <strong>mixed models</strong>, <strong>user-independent models</strong>, and <strong>user-dependent models</strong>. I will present how to train each type of model using a database with actions recorded with a motion capture system. After that, I will also show you how to build <strong>adaptive models</strong> with the objective of increasing the prediction performance for a particular user.</p>
<div id="mixed-models" class="section level2" number="9.1">
<h2><span class="header-section-number">9.1</span> Mixed Models</h2>
<p>Mixed models are trained and validated as ordinary, without considering information about mappings between data points and users. Suppose we have a dataset as shown in Figure <a href="multiuser.html#fig:tblMixModel">9.1</a>. The first column is the user id, the second column the label we want to predict and the last two columns are two arbitrary features.</p>
<div class="figure" style="text-align: center"><span id="fig:tblMixModel"></span>
<img src="images/table_mix_model.png" alt="Example dataset with a binary label and 2 features." width="30%" />
<p class="caption">
FIGURE 9.1: Example dataset with a binary label and 2 features.
</p>
</div>
<p>With a mixed model, we would just remove the <em>userid</em> column and perform <span class="math inline">\(k\)</span>-fold cross-validation or hold-out validation as usual. In fact, this is what we have been doing so far. By doing so, some random data points will end up in the train set and others in the test set regardless of which data point was generated by which user. The user rows are just <em>mixed</em>, thus the <em>mixed model</em> name. This model assumes that the data was generated by a single user. One disadvantage of validating a system using a mixed model is that the performance results could be overestimated. When randomly splitting into train and test sets, some data points for a given user could end up in each of the splits. At inference time, when presenting a test sample belonging to a particular user, it is likely that the training set of the model already included some data from that particular user. Thus, the model already knows a little bit about that user so we can expect an accurate prediction. However, this assumption not always holds true. If the model is to be used on a <strong>new user</strong> that the model has never seen before, then, it may not produce very accurate predictions.</p>
<p><strong>When should a mixed model be used to validate a system?</strong></p>
<ol style="list-style-type: decimal">
<li>When you know you will have available train data belonging to the intended target users.</li>
<li>In many cases, a dataset already has missing information about the mapping between rows and users. That is, a <em>userid</em> column is not present. In those cases, the best performance estimation would be through the use of a mixed model.</li>
</ol>
<p>To demonstrate the differences between the three types of models (mixed, user-independent, and user-dependent) I will use the <em>SKELETON ACTIONS</em> dataset. First, a brief description of the dataset is presented including details about how the features were extracted. Then, the dataset is used to train a mixed model and in the following subsections, it is used to train user-independent and user-dependent models.</p>
<div id="skeleton-action-recognition-with-mixed-models" class="section level3" number="9.1.1">
<h3><span class="header-section-number">9.1.1</span> Skeleton Action Recognition with Mixed Models</h3>

<div class="rmdfolder">
<code>preprocess_skeleton_actions.R</code> <code>classify_skeleton_actions.R</code>
</div>
<p>To demonstrate the three different types of models I chose the <strong>UTD-MHAD dataset</strong> <span class="citation">(<a href="#ref-chen2015utd" role="doc-biblioref">Chen, Jafari, and Kehtarnavaz 2015</a>)</span> and from now on, I will refer to it as the <em>SKELETON ACTIONS</em> dataset. This database is suitable because it was collected by <span class="math inline">\(8\)</span> persons (<span class="math inline">\(4\)</span> females/<span class="math inline">\(4\)</span> males) and each file has a subject id, thus, we know which actions were collected by which users. There are <span class="math inline">\(27\)</span> actions including: <em>‘right-hand wave’</em>, <em>‘two hand front clap’</em>, <em>‘basketball shoot’</em>, <em>‘front boxing’</em>, etc.</p>
<p>The data was recorded using a Kinect camera and an inertial sensor unit. Each subject repeated each of the <span class="math inline">\(27\)</span> actions <span class="math inline">\(4\)</span> times. More information about the collection process and pictures is available in the original dataset website <a href="https://personal.utdallas.edu/~kehtar/UTD-MHAD.html" class="uri">https://personal.utdallas.edu/~kehtar/UTD-MHAD.html</a>.</p>
<p>For our examples, I only consider the <em>skeleton data</em> generated by the Kinect camera. These data consists of human body joints (<span class="math inline">\(20\)</span> joints). Each file contains one action for one user and one repetition. The file names are of the form: <code>aA_sS_tT_skeleton.mat</code>. The <code>A</code> is the action id, the <code>S</code> is the subject id and the <code>T</code> is the trial (repetition) number. For each time frame, the <span class="math inline">\(3\)</span>D positions of the <span class="math inline">\(20\)</span> joints are recorded.</p>
<p>The script <code>preprocess_skeleton_actions.R</code> shows how to read the files and plot the actions. The files are stored in Matlab format. The library <code>R.matlab</code> <span class="citation">(<a href="#ref-rmatlab" role="doc-biblioref">Bengtsson 2018</a>)</span> can be used to read the files.</p>
<div class="sourceCode" id="cb192"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb192-1"><a href="multiuser.html#cb192-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Path to one of the files.</span></span>
<span id="cb192-2"><a href="multiuser.html#cb192-2" aria-hidden="true" tabindex="-1"></a>filepath <span class="ot">&lt;-</span> <span class="st">&quot;/skeleton_actions/a7_s1_t1_skeleton.mat&quot;</span></span>
<span id="cb192-3"><a href="multiuser.html#cb192-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb192-4"><a href="multiuser.html#cb192-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Read skeleton file.</span></span>
<span id="cb192-5"><a href="multiuser.html#cb192-5" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">readMat</span>(filepath)<span class="sc">$</span>d.skel</span>
<span id="cb192-6"><a href="multiuser.html#cb192-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb192-7"><a href="multiuser.html#cb192-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Print dimensions.</span></span>
<span id="cb192-8"><a href="multiuser.html#cb192-8" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(df)</span>
<span id="cb192-9"><a href="multiuser.html#cb192-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] 20  3 66</span></span></code></pre></div>
<p>From the file name, we see that this corresponds to action <span class="math inline">\(7\)</span> (basketball shoot), from subject <span class="math inline">\(1\)</span> and trial <span class="math inline">\(1\)</span>. The <code>readMat()</code> function reads the file contents and stores them as a <span class="math inline">\(3\)</span>D array in <code>df</code>. If we print the dimensions we see that the first one corresponds to the number of joints, the second one are the positions (<em>x</em>, <em>y</em>, <em>z</em>), and the last dimension is the number of frames, in this case <span class="math inline">\(66\)</span> frames.</p>
<p>We extract the first time-frame as follows:</p>
<div class="sourceCode" id="cb193"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb193-1"><a href="multiuser.html#cb193-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Select the first frame.</span></span>
<span id="cb193-2"><a href="multiuser.html#cb193-2" aria-hidden="true" tabindex="-1"></a>frame <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(df[, , <span class="dv">1</span>])</span>
<span id="cb193-3"><a href="multiuser.html#cb193-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb193-4"><a href="multiuser.html#cb193-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Print dimensions.</span></span>
<span id="cb193-5"><a href="multiuser.html#cb193-5" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(frame)</span>
<span id="cb193-6"><a href="multiuser.html#cb193-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] 20  3</span></span></code></pre></div>
<p>Each frame can then be plotted. The plotting code is included in the script. Figure <a href="multiuser.html#fig:sklBasket">9.2</a> shows how the skeleton looks like for six of the time frames. The script also has code to animate the actions.</p>
<div class="figure" style="text-align: center"><span id="fig:sklBasket"></span>
<img src="images/skl_basket.png" alt="Skeleton of basketball shoot action. Six frames sampled from the entire sequence." width="100%" />
<p class="caption">
FIGURE 9.2: Skeleton of basketball shoot action. Six frames sampled from the entire sequence.
</p>
</div>
<p>We will represent each action (file) as a feature vector. The same script also shows the code to extract the feature vectors from each action. To extract the features, a reference point in the skeleton is selected, in this case the spine (joint <span class="math inline">\(3\)</span>). Then, for each time frame, the distance between all joints (excluding the reference point) and the reference point is calculated. Finally, for each distance, the <em>mean</em>, <em>min</em>, and <em>max</em> are computed across all time frames. Since there are <span class="math inline">\(19\)</span> joints (excluding the spine), we end up with <span class="math inline">\(19*3=57\)</span> features. Figure <a href="multiuser.html#fig:sklFeatures">9.3</a> shows how the final dataset looks like. It only shows the first four features out of the <span class="math inline">\(57\)</span>, the user id and the labels.</p>

<div class="figure" style="text-align: center"><span id="fig:sklFeatures"></span>
<img src="images/skl_features.png" alt="First rows of the skeleton dataset after feature extraction showing the first 4 features. Source: Original data from C. Chen, R. Jafari, and N. Kehtarnavaz, “UTD-MHAD: A Multimodal Dataset for Human Action Recognition Utilizing a Depth Camera and a Wearable Inertial Sensor,” Proceedings of IEEE International Conference on Image Processing, Canada, September 2015." width="70%" />
<p class="caption">
FIGURE 9.3: First rows of the skeleton dataset after feature extraction showing the first 4 features. Source: Original data from C. Chen, R. Jafari, and N. Kehtarnavaz, “UTD-MHAD: A Multimodal Dataset for Human Action Recognition Utilizing a Depth Camera and a Wearable Inertial Sensor,” <em>Proceedings of IEEE International Conference on Image Processing</em>, Canada, September 2015.
</p>
</div>

<div class="rmdgoodpractice">
The following examples assume that the file <em>dataset.csv</em> with the extracted features already exsits in the <code>skeleton_actions/</code> directory. To generate this file, run the feature extraction code in the script <code>preprocess_skeleton_actions.R</code>.
</div>
<p>Once the dataset is in a suitable format, we proceed to <strong>train our mixed model</strong>. The script containing the full code for training the different types of models is <code>classify_skeleton_actions.R</code>. This script makes use of the <em>dataset.csv</em> file.</p>
<p>First, the auxiliary functions are loaded because we will use the <code>normalize()</code> function to normalize the data. We will use a Random Forest for the classification and the <code>caret</code> package to compute the performance metrics.</p>
<div class="sourceCode" id="cb194"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb194-1"><a href="multiuser.html#cb194-1" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="fu">file.path</span>(<span class="st">&quot;..&quot;</span>,<span class="st">&quot;auxiliary_functions&quot;</span>,<span class="st">&quot;globals.R&quot;</span>))</span>
<span id="cb194-2"><a href="multiuser.html#cb194-2" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="fu">file.path</span>(<span class="st">&quot;..&quot;</span>,<span class="st">&quot;auxiliary_functions&quot;</span>,<span class="st">&quot;functions.R&quot;</span>))</span>
<span id="cb194-3"><a href="multiuser.html#cb194-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(randomForest)</span>
<span id="cb194-4"><a href="multiuser.html#cb194-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(caret)</span>
<span id="cb194-5"><a href="multiuser.html#cb194-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-6"><a href="multiuser.html#cb194-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Path to the csv file containing the extracted features.</span></span>
<span id="cb194-7"><a href="multiuser.html#cb194-7" aria-hidden="true" tabindex="-1"></a><span class="co"># preprocess_skeleton_actins.R contains</span></span>
<span id="cb194-8"><a href="multiuser.html#cb194-8" aria-hidden="true" tabindex="-1"></a><span class="co"># the code used to extract the features.</span></span>
<span id="cb194-9"><a href="multiuser.html#cb194-9" aria-hidden="true" tabindex="-1"></a>filepath <span class="ot">&lt;-</span> <span class="fu">file.path</span>(datasets_path,</span>
<span id="cb194-10"><a href="multiuser.html#cb194-10" aria-hidden="true" tabindex="-1"></a>                      <span class="st">&quot;skeleton_actions&quot;</span>,</span>
<span id="cb194-11"><a href="multiuser.html#cb194-11" aria-hidden="true" tabindex="-1"></a>                      <span class="st">&quot;dataset.csv&quot;</span>)</span>
<span id="cb194-12"><a href="multiuser.html#cb194-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Load dataset.</span></span>
<span id="cb194-13"><a href="multiuser.html#cb194-13" aria-hidden="true" tabindex="-1"></a>dataset <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(filepath, <span class="at">stringsAsFactors =</span> T)</span>
<span id="cb194-14"><a href="multiuser.html#cb194-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-15"><a href="multiuser.html#cb194-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract unique labels.</span></span>
<span id="cb194-16"><a href="multiuser.html#cb194-16" aria-hidden="true" tabindex="-1"></a>unique.actions <span class="ot">&lt;-</span> <span class="fu">as.character</span>(<span class="fu">unique</span>(dataset<span class="sc">$</span>label))</span>
<span id="cb194-17"><a href="multiuser.html#cb194-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-18"><a href="multiuser.html#cb194-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Print the unique labels.</span></span>
<span id="cb194-19"><a href="multiuser.html#cb194-19" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(unique.actions)</span>
<span id="cb194-20"><a href="multiuser.html#cb194-20" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  [1] &quot;a1&quot;  &quot;a10&quot; &quot;a11&quot; &quot;a12&quot; &quot;a13&quot; &quot;a14&quot; &quot;a15&quot; &quot;a16&quot; &quot;a17&quot;</span></span>
<span id="cb194-21"><a href="multiuser.html#cb194-21" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [10] &quot;a18&quot; &quot;a19&quot; &quot;a2&quot;  &quot;a20&quot; &quot;a21&quot; &quot;a22&quot; &quot;a23&quot; &quot;a24&quot; &quot;a25&quot;</span></span>
<span id="cb194-22"><a href="multiuser.html#cb194-22" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [19] &quot;a26&quot; &quot;a27&quot; &quot;a3&quot;  &quot;a4&quot;  &quot;a5&quot;  &quot;a6&quot;  &quot;a7&quot;  &quot;a8&quot;  &quot;a9&quot; </span></span></code></pre></div>
<p>The <code>unique.actions</code> variable stores the name of all actions. We will need it later to define the levels of the factor object. Next, we generate <span class="math inline">\(10\)</span> folds and define some variables to store the performance metrics including the <em>accuracy</em>, <em>recall</em>, and <em>precision</em>. In each iteration during cross-validation, we will compute and store those performance metrics.</p>
<div class="sourceCode" id="cb195"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb195-1"><a href="multiuser.html#cb195-1" aria-hidden="true" tabindex="-1"></a>k <span class="ot">&lt;-</span> <span class="dv">10</span> <span class="co"># Number of folds.</span></span>
<span id="cb195-2"><a href="multiuser.html#cb195-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1234</span>)</span>
<span id="cb195-3"><a href="multiuser.html#cb195-3" aria-hidden="true" tabindex="-1"></a>folds <span class="ot">&lt;-</span> <span class="fu">sample</span>(k, <span class="fu">nrow</span>(dataset), <span class="at">replace =</span> <span class="cn">TRUE</span>)</span>
<span id="cb195-4"><a href="multiuser.html#cb195-4" aria-hidden="true" tabindex="-1"></a>accuracies <span class="ot">&lt;-</span> <span class="cn">NULL</span>; recalls <span class="ot">&lt;-</span> <span class="cn">NULL</span>; precisions <span class="ot">&lt;-</span> <span class="cn">NULL</span></span></code></pre></div>
<p>In the next code snippet, the actual cross-validation is performed. This is just the usual cross-validation procedure. The <code>normalize()</code> function defined in the auxiliary functions is used to normalize the data by only learning the parameters from the train set and applying them to the test set. Then, the Random Forest is fitted with the train set. One thing to note here is that the <code>userid</code> field is removed: <code>trainset[,-1]</code> since we are not using users’ information in the mixed model. Then, predictions on the test set are obtained and the accuracy, recall, and precision are computed during each iteration.</p>
<div class="sourceCode" id="cb196"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb196-1"><a href="multiuser.html#cb196-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Perform k-fold cross-validation.</span></span>
<span id="cb196-2"><a href="multiuser.html#cb196-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>k){</span>
<span id="cb196-3"><a href="multiuser.html#cb196-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb196-4"><a href="multiuser.html#cb196-4" aria-hidden="true" tabindex="-1"></a>  trainset <span class="ot">&lt;-</span> dataset[<span class="fu">which</span>(folds <span class="sc">!=</span> i,),]</span>
<span id="cb196-5"><a href="multiuser.html#cb196-5" aria-hidden="true" tabindex="-1"></a>  testset <span class="ot">&lt;-</span> dataset[<span class="fu">which</span>(folds <span class="sc">==</span> i,),]</span>
<span id="cb196-6"><a href="multiuser.html#cb196-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb196-7"><a href="multiuser.html#cb196-7" aria-hidden="true" tabindex="-1"></a>  <span class="co">#Normalize.</span></span>
<span id="cb196-8"><a href="multiuser.html#cb196-8" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="fu">normalize</span>(trainset, testset)</span>
<span id="cb196-9"><a href="multiuser.html#cb196-9" aria-hidden="true" tabindex="-1"></a>  trainset <span class="ot">&lt;-</span> res<span class="sc">$</span>train</span>
<span id="cb196-10"><a href="multiuser.html#cb196-10" aria-hidden="true" tabindex="-1"></a>  testset <span class="ot">&lt;-</span> res<span class="sc">$</span>test</span>
<span id="cb196-11"><a href="multiuser.html#cb196-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb196-12"><a href="multiuser.html#cb196-12" aria-hidden="true" tabindex="-1"></a>  rf <span class="ot">&lt;-</span> <span class="fu">randomForest</span>(label <span class="sc">~</span>., trainset[,<span class="sc">-</span><span class="dv">1</span>])</span>
<span id="cb196-13"><a href="multiuser.html#cb196-13" aria-hidden="true" tabindex="-1"></a>  preds.rf <span class="ot">&lt;-</span> <span class="fu">as.character</span>(<span class="fu">predict</span>(rf,</span>
<span id="cb196-14"><a href="multiuser.html#cb196-14" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">newdata =</span> testset[,<span class="sc">-</span><span class="dv">1</span>]))</span>
<span id="cb196-15"><a href="multiuser.html#cb196-15" aria-hidden="true" tabindex="-1"></a>  groundTruth <span class="ot">&lt;-</span> <span class="fu">as.character</span>(testset<span class="sc">$</span>label)</span>
<span id="cb196-16"><a href="multiuser.html#cb196-16" aria-hidden="true" tabindex="-1"></a>  cm.rf <span class="ot">&lt;-</span> <span class="fu">confusionMatrix</span>(<span class="fu">factor</span>(preds.rf,</span>
<span id="cb196-17"><a href="multiuser.html#cb196-17" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">levels =</span> unique.actions),</span>
<span id="cb196-18"><a href="multiuser.html#cb196-18" aria-hidden="true" tabindex="-1"></a>                           <span class="fu">factor</span>(groundTruth,</span>
<span id="cb196-19"><a href="multiuser.html#cb196-19" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">levels =</span> unique.actions))</span>
<span id="cb196-20"><a href="multiuser.html#cb196-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb196-21"><a href="multiuser.html#cb196-21" aria-hidden="true" tabindex="-1"></a>  accuracies <span class="ot">&lt;-</span> <span class="fu">c</span>(accuracies, cm.rf<span class="sc">$</span>overall[<span class="st">&quot;Accuracy&quot;</span>])</span>
<span id="cb196-22"><a href="multiuser.html#cb196-22" aria-hidden="true" tabindex="-1"></a>  metrics <span class="ot">&lt;-</span> <span class="fu">colMeans</span>(cm.rf<span class="sc">$</span>byClass[,<span class="fu">c</span>(<span class="st">&quot;Recall&quot;</span>,</span>
<span id="cb196-23"><a href="multiuser.html#cb196-23" aria-hidden="true" tabindex="-1"></a>                                       <span class="st">&quot;Specificity&quot;</span>,</span>
<span id="cb196-24"><a href="multiuser.html#cb196-24" aria-hidden="true" tabindex="-1"></a>                                       <span class="st">&quot;Precision&quot;</span>,</span>
<span id="cb196-25"><a href="multiuser.html#cb196-25" aria-hidden="true" tabindex="-1"></a>                                       <span class="st">&quot;F1&quot;</span>)],</span>
<span id="cb196-26"><a href="multiuser.html#cb196-26" aria-hidden="true" tabindex="-1"></a>                      <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb196-27"><a href="multiuser.html#cb196-27" aria-hidden="true" tabindex="-1"></a>  recalls <span class="ot">&lt;-</span> <span class="fu">c</span>(recalls, metrics[<span class="st">&quot;Recall&quot;</span>])</span>
<span id="cb196-28"><a href="multiuser.html#cb196-28" aria-hidden="true" tabindex="-1"></a>  precisions <span class="ot">&lt;-</span> <span class="fu">c</span>(precisions, metrics[<span class="st">&quot;Precision&quot;</span>])</span>
<span id="cb196-29"><a href="multiuser.html#cb196-29" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Finally, the average performance across folds for each of the metrics is printed.</p>
<div class="sourceCode" id="cb197"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb197-1"><a href="multiuser.html#cb197-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Print performance metrics.</span></span>
<span id="cb197-2"><a href="multiuser.html#cb197-2" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(accuracies)</span>
<span id="cb197-3"><a href="multiuser.html#cb197-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] 0.9277258</span></span>
<span id="cb197-4"><a href="multiuser.html#cb197-4" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(recalls)</span>
<span id="cb197-5"><a href="multiuser.html#cb197-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] 0.9372515</span></span>
<span id="cb197-6"><a href="multiuser.html#cb197-6" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(precisions)</span>
<span id="cb197-7"><a href="multiuser.html#cb197-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] 0.9208455</span></span></code></pre></div>
<p>The results look promising with an average <em>accuracy</em> of <span class="math inline">\(92.7\%\)</span>, a <em>recall</em> of <span class="math inline">\(93.7\%\)</span>, and a <em>precision</em> of <span class="math inline">\(92.0\%\)</span>. One important thing to remember is that the mixed model assumes that the training data contains instances belonging to users in the test set. Thus, the model already knows a little bit about the users in the test set.</p>
<p>Now, imagine that you want to estimate the performance of the model in a situation where a completely new user is shown to the model, that is, the model does not know anything about this user. We can model those situations using a <strong>user-independent model</strong> which is the topic of the next section.</p>
</div>
</div>
<div id="user-independent-models" class="section level2" number="9.2">
<h2><span class="header-section-number">9.2</span> User-independent Models</h2>
<p>The <strong>user-independent</strong> model allows us to estimate the performance of a system on new users. That is, the model does not contain any information about the target user. This resembles a scenario when the user wants to use a service out-of-the-box without having to go through a calibration process or having to collect training data. To build a user-independent model we just need to make sure that the training data does not contain any information about the users on the test set. We can achieve this by splitting the dataset into two disjoint groups of users based on their ids. For example, assign <span class="math inline">\(70\%\)</span> of the users to the train set and the remaining to the test set.</p>
<p>If the dataset is small, we can optimize its usage by performing <strong>leave-one-user-out cross validation</strong>. That is, if the dataset has <span class="math inline">\(n\)</span> users, then, <span class="math inline">\(n\)</span> iterations are performed. In each iteration, one user is selected as the test set and the remaining are used as the train set. Figure <a href="multiuser.html#fig:loov">9.4</a> illustrates an example of <em>leave-one-user-out cross validation</em> for the first <span class="math inline">\(2\)</span> iterations.</p>
<div class="figure" style="text-align: center"><span id="fig:loov"></span>
<img src="images/loov.png" alt="First 2 iterations of leave-one-user-out cross validation." width="70%" />
<p class="caption">
FIGURE 9.4: First 2 iterations of leave-one-user-out cross validation.
</p>
</div>
<p>By doing this, we guarantee that the model knows anything about the target user. To implement this leave-one-user-out validation method in our skeleton recognition case, let’s first define some initialization variables. These include the <code>unique.users</code> variable which stores the ids of all users in the database. As before, we will compute the <em>accuracy</em>, <em>recall</em>, and <em>precision</em> so we define variables to store those metrics for each user.</p>
<div class="sourceCode" id="cb198"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb198-1"><a href="multiuser.html#cb198-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get a list of unique users.</span></span>
<span id="cb198-2"><a href="multiuser.html#cb198-2" aria-hidden="true" tabindex="-1"></a>unique.users <span class="ot">&lt;-</span> <span class="fu">as.character</span>(<span class="fu">unique</span>(dataset<span class="sc">$</span>userid))</span>
<span id="cb198-3"><a href="multiuser.html#cb198-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb198-4"><a href="multiuser.html#cb198-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Print the unique user ids.</span></span>
<span id="cb198-5"><a href="multiuser.html#cb198-5" aria-hidden="true" tabindex="-1"></a>unique.users</span>
<span id="cb198-6"><a href="multiuser.html#cb198-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] &quot;s1&quot; &quot;s2&quot; &quot;s3&quot; &quot;s4&quot; &quot;s5&quot; &quot;s6&quot; &quot;s7&quot; &quot;s8&quot;</span></span>
<span id="cb198-7"><a href="multiuser.html#cb198-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb198-8"><a href="multiuser.html#cb198-8" aria-hidden="true" tabindex="-1"></a>accuracies <span class="ot">&lt;-</span> <span class="cn">NULL</span>; recalls <span class="ot">&lt;-</span> <span class="cn">NULL</span>; precisions <span class="ot">&lt;-</span> <span class="cn">NULL</span></span></code></pre></div>
<p>Then, we iterate through each user, build the corresponding train and test sets, and train the classifiers. Here, we make sure that the test set only includes data points belonging to a single user.</p>
<div class="sourceCode" id="cb199"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb199-1"><a href="multiuser.html#cb199-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1234</span>)</span>
<span id="cb199-2"><a href="multiuser.html#cb199-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb199-3"><a href="multiuser.html#cb199-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(user <span class="cf">in</span> unique.users){</span>
<span id="cb199-4"><a href="multiuser.html#cb199-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb199-5"><a href="multiuser.html#cb199-5" aria-hidden="true" tabindex="-1"></a>  testset <span class="ot">&lt;-</span> dataset[<span class="fu">which</span>(dataset<span class="sc">$</span>userid <span class="sc">==</span> user),]</span>
<span id="cb199-6"><a href="multiuser.html#cb199-6" aria-hidden="true" tabindex="-1"></a>  trainset <span class="ot">&lt;-</span> dataset[<span class="fu">which</span>(dataset<span class="sc">$</span>userid <span class="sc">!=</span> user),]</span>
<span id="cb199-7"><a href="multiuser.html#cb199-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb199-8"><a href="multiuser.html#cb199-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Normalize. Not really needed here since Random Forest</span></span>
<span id="cb199-9"><a href="multiuser.html#cb199-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># is not affected by different scales.</span></span>
<span id="cb199-10"><a href="multiuser.html#cb199-10" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="fu">normalize</span>(trainset, testset)</span>
<span id="cb199-11"><a href="multiuser.html#cb199-11" aria-hidden="true" tabindex="-1"></a>  trainset <span class="ot">&lt;-</span> res<span class="sc">$</span>train</span>
<span id="cb199-12"><a href="multiuser.html#cb199-12" aria-hidden="true" tabindex="-1"></a>  testset <span class="ot">&lt;-</span> res<span class="sc">$</span>test</span>
<span id="cb199-13"><a href="multiuser.html#cb199-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb199-14"><a href="multiuser.html#cb199-14" aria-hidden="true" tabindex="-1"></a>  rf <span class="ot">&lt;-</span> <span class="fu">randomForest</span>(label <span class="sc">~</span>., trainset[,<span class="sc">-</span><span class="dv">1</span>])</span>
<span id="cb199-15"><a href="multiuser.html#cb199-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb199-16"><a href="multiuser.html#cb199-16" aria-hidden="true" tabindex="-1"></a>  preds.rf <span class="ot">&lt;-</span> <span class="fu">as.character</span>(<span class="fu">predict</span>(rf, <span class="at">newdata =</span> testset[,<span class="sc">-</span><span class="dv">1</span>]))</span>
<span id="cb199-17"><a href="multiuser.html#cb199-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb199-18"><a href="multiuser.html#cb199-18" aria-hidden="true" tabindex="-1"></a>  groundTruth <span class="ot">&lt;-</span> <span class="fu">as.character</span>(testset<span class="sc">$</span>label)</span>
<span id="cb199-19"><a href="multiuser.html#cb199-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb199-20"><a href="multiuser.html#cb199-20" aria-hidden="true" tabindex="-1"></a>  cm.rf <span class="ot">&lt;-</span> <span class="fu">confusionMatrix</span>(<span class="fu">factor</span>(preds.rf,</span>
<span id="cb199-21"><a href="multiuser.html#cb199-21" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">levels =</span> unique.actions),</span>
<span id="cb199-22"><a href="multiuser.html#cb199-22" aria-hidden="true" tabindex="-1"></a>                           <span class="fu">factor</span>(groundTruth,</span>
<span id="cb199-23"><a href="multiuser.html#cb199-23" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">levels =</span> unique.actions))</span>
<span id="cb199-24"><a href="multiuser.html#cb199-24" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb199-25"><a href="multiuser.html#cb199-25" aria-hidden="true" tabindex="-1"></a>  accuracies <span class="ot">&lt;-</span> <span class="fu">c</span>(accuracies, cm.rf<span class="sc">$</span>overall[<span class="st">&quot;Accuracy&quot;</span>])</span>
<span id="cb199-26"><a href="multiuser.html#cb199-26" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb199-27"><a href="multiuser.html#cb199-27" aria-hidden="true" tabindex="-1"></a>  metrics <span class="ot">&lt;-</span> <span class="fu">colMeans</span>(cm.rf<span class="sc">$</span>byClass[,<span class="fu">c</span>(<span class="st">&quot;Recall&quot;</span>,</span>
<span id="cb199-28"><a href="multiuser.html#cb199-28" aria-hidden="true" tabindex="-1"></a>                                       <span class="st">&quot;Specificity&quot;</span>,</span>
<span id="cb199-29"><a href="multiuser.html#cb199-29" aria-hidden="true" tabindex="-1"></a>                                       <span class="st">&quot;Precision&quot;</span>,</span>
<span id="cb199-30"><a href="multiuser.html#cb199-30" aria-hidden="true" tabindex="-1"></a>                                       <span class="st">&quot;F1&quot;</span>)],</span>
<span id="cb199-31"><a href="multiuser.html#cb199-31" aria-hidden="true" tabindex="-1"></a>           <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb199-32"><a href="multiuser.html#cb199-32" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb199-33"><a href="multiuser.html#cb199-33" aria-hidden="true" tabindex="-1"></a>  recalls <span class="ot">&lt;-</span> <span class="fu">c</span>(recalls, metrics[<span class="st">&quot;Recall&quot;</span>])</span>
<span id="cb199-34"><a href="multiuser.html#cb199-34" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb199-35"><a href="multiuser.html#cb199-35" aria-hidden="true" tabindex="-1"></a>  precisions <span class="ot">&lt;-</span> <span class="fu">c</span>(precisions, metrics[<span class="st">&quot;Precision&quot;</span>])</span>
<span id="cb199-36"><a href="multiuser.html#cb199-36" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Now we print the average performance metrics across users.</p>
<div class="sourceCode" id="cb200"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb200-1"><a href="multiuser.html#cb200-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(accuracies)</span>
<span id="cb200-2"><a href="multiuser.html#cb200-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] 0.5807805</span></span>
<span id="cb200-3"><a href="multiuser.html#cb200-3" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(recalls)</span>
<span id="cb200-4"><a href="multiuser.html#cb200-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] 0.5798611</span></span>
<span id="cb200-5"><a href="multiuser.html#cb200-5" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(precisions)</span>
<span id="cb200-6"><a href="multiuser.html#cb200-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] 0.6539715</span></span></code></pre></div>
<p>Those numbers are surprising! In the previous section, our <strong>mixed model</strong> had an accuracy of <span class="math inline">\(92.7\%\)</span> and now the <strong>user-independent model</strong> has an accuracy of only <span class="math inline">\(58.0\%\)</span>! This is because the latter didn’t know anything about the target user. Since each person is different, the <strong>user-independent model</strong> was not able to capture the patterns of new users and this had a big impact on the performance.</p>
<p><strong>When should a user-independent model be used to validate a system?</strong></p>
<ol style="list-style-type: decimal">
<li>When you expect the system to be used out-of-the-box by new users and the system does not have any data from those new users.</li>
</ol>
<p>The main advantage of the user-independent model is that it does not require training data from the <em>target users</em> so they can start using it right away at the expense of lower accuracy.</p>
<p>The opposite case is when a model is trained specifically for the <em>target user</em>. This model is called the <strong>user-dependent model</strong> and will be presented in the next section.</p>
</div>
<div id="user-dependent-models" class="section level2" number="9.3">
<h2><span class="header-section-number">9.3</span> User-dependent Models</h2>
<p>A <strong>user-dependent model</strong> is trained with data belonging only to the <em>target user</em>. In general, this type of model performs better compared to the <em>mixed model</em> and <em>user-independent model</em>. This is because the model captures the particularities of a specific user. The way to evaluate user-dependent models is to iterate through each user. For each user, build and test a model only with her/his data. The per-user evaluation can be done using <span class="math inline">\(k\)</span>-fold cross-validation, for example. For the skeleton database, we only have <span class="math inline">\(4\)</span> instances per type of action. The number of unique classes (<span class="math inline">\(27\)</span>) is high compared to the number of instances per action. If we do, for example, <span class="math inline">\(10\)</span>-fold cross-validation, it is very likely that the train sets will not contain examples for several of the possible actions. To avoid this, we will do <em>leave-one-out cross validation</em> within each user. This means that we need to iterate through each instance. In each iteration, the selected instance is used as the test set and the remaining ones are used for the train set.</p>
<div class="sourceCode" id="cb201"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb201-1"><a href="multiuser.html#cb201-1" aria-hidden="true" tabindex="-1"></a>unique.users <span class="ot">&lt;-</span> <span class="fu">as.character</span>(<span class="fu">unique</span>(dataset<span class="sc">$</span>userid))</span>
<span id="cb201-2"><a href="multiuser.html#cb201-2" aria-hidden="true" tabindex="-1"></a>accuracies <span class="ot">&lt;-</span> <span class="cn">NULL</span>; recalls <span class="ot">&lt;-</span> <span class="cn">NULL</span>; precisions <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb201-3"><a href="multiuser.html#cb201-3" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1234</span>)</span>
<span id="cb201-4"><a href="multiuser.html#cb201-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb201-5"><a href="multiuser.html#cb201-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Iterate through each user.</span></span>
<span id="cb201-6"><a href="multiuser.html#cb201-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(user <span class="cf">in</span> unique.users){</span>
<span id="cb201-7"><a href="multiuser.html#cb201-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">paste0</span>(<span class="st">&quot;Evaluating user &quot;</span>, user))</span>
<span id="cb201-8"><a href="multiuser.html#cb201-8" aria-hidden="true" tabindex="-1"></a>  user.data <span class="ot">&lt;-</span> dataset[<span class="fu">which</span>(dataset<span class="sc">$</span>userid <span class="sc">==</span> user), <span class="sc">-</span><span class="dv">1</span>]</span>
<span id="cb201-9"><a href="multiuser.html#cb201-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb201-10"><a href="multiuser.html#cb201-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Leave-one-out cross validation within each user.</span></span>
<span id="cb201-11"><a href="multiuser.html#cb201-11" aria-hidden="true" tabindex="-1"></a>  predictions.rf <span class="ot">&lt;-</span> <span class="cn">NULL</span>; groundTruth <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb201-12"><a href="multiuser.html#cb201-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb201-13"><a href="multiuser.html#cb201-13" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(user.data)){</span>
<span id="cb201-14"><a href="multiuser.html#cb201-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb201-15"><a href="multiuser.html#cb201-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Normalize. Not really needed here since Random Forest</span></span>
<span id="cb201-16"><a href="multiuser.html#cb201-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># is not affected by different scales.</span></span>
<span id="cb201-17"><a href="multiuser.html#cb201-17" aria-hidden="true" tabindex="-1"></a>    testset <span class="ot">&lt;-</span> user.data[i,]</span>
<span id="cb201-18"><a href="multiuser.html#cb201-18" aria-hidden="true" tabindex="-1"></a>    trainset <span class="ot">&lt;-</span> user.data[<span class="sc">-</span>i,]</span>
<span id="cb201-19"><a href="multiuser.html#cb201-19" aria-hidden="true" tabindex="-1"></a>    res <span class="ot">&lt;-</span> <span class="fu">normalize</span>(trainset, testset)</span>
<span id="cb201-20"><a href="multiuser.html#cb201-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb201-21"><a href="multiuser.html#cb201-21" aria-hidden="true" tabindex="-1"></a>    testset <span class="ot">&lt;-</span> res<span class="sc">$</span>test</span>
<span id="cb201-22"><a href="multiuser.html#cb201-22" aria-hidden="true" tabindex="-1"></a>    trainset <span class="ot">&lt;-</span> res<span class="sc">$</span>train</span>
<span id="cb201-23"><a href="multiuser.html#cb201-23" aria-hidden="true" tabindex="-1"></a>    rf <span class="ot">&lt;-</span> <span class="fu">randomForest</span>(label <span class="sc">~</span>., trainset)</span>
<span id="cb201-24"><a href="multiuser.html#cb201-24" aria-hidden="true" tabindex="-1"></a>    preds.rf <span class="ot">&lt;-</span> <span class="fu">as.character</span>(<span class="fu">predict</span>(rf, <span class="at">newdata =</span> testset))</span>
<span id="cb201-25"><a href="multiuser.html#cb201-25" aria-hidden="true" tabindex="-1"></a>    predictions.rf <span class="ot">&lt;-</span> <span class="fu">c</span>(predictions.rf, preds.rf)</span>
<span id="cb201-26"><a href="multiuser.html#cb201-26" aria-hidden="true" tabindex="-1"></a>    groundTruth <span class="ot">&lt;-</span> <span class="fu">c</span>(groundTruth, <span class="fu">as.character</span>(testset<span class="sc">$</span>label))</span>
<span id="cb201-27"><a href="multiuser.html#cb201-27" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb201-28"><a href="multiuser.html#cb201-28" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb201-29"><a href="multiuser.html#cb201-29" aria-hidden="true" tabindex="-1"></a>  cm.rf <span class="ot">&lt;-</span> <span class="fu">confusionMatrix</span>(<span class="fu">factor</span>(predictions.rf,</span>
<span id="cb201-30"><a href="multiuser.html#cb201-30" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">levels =</span> unique.actions),</span>
<span id="cb201-31"><a href="multiuser.html#cb201-31" aria-hidden="true" tabindex="-1"></a>                           <span class="fu">factor</span>(groundTruth,</span>
<span id="cb201-32"><a href="multiuser.html#cb201-32" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">levels =</span> unique.actions))</span>
<span id="cb201-33"><a href="multiuser.html#cb201-33" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb201-34"><a href="multiuser.html#cb201-34" aria-hidden="true" tabindex="-1"></a>  accuracies <span class="ot">&lt;-</span> <span class="fu">c</span>(accuracies, cm.rf<span class="sc">$</span>overall[<span class="st">&quot;Accuracy&quot;</span>])</span>
<span id="cb201-35"><a href="multiuser.html#cb201-35" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb201-36"><a href="multiuser.html#cb201-36" aria-hidden="true" tabindex="-1"></a>  metrics <span class="ot">&lt;-</span> <span class="fu">colMeans</span>(cm.rf<span class="sc">$</span>byClass[,<span class="fu">c</span>(<span class="st">&quot;Recall&quot;</span>,</span>
<span id="cb201-37"><a href="multiuser.html#cb201-37" aria-hidden="true" tabindex="-1"></a>                                       <span class="st">&quot;Specificity&quot;</span>,</span>
<span id="cb201-38"><a href="multiuser.html#cb201-38" aria-hidden="true" tabindex="-1"></a>                                       <span class="st">&quot;Precision&quot;</span>,</span>
<span id="cb201-39"><a href="multiuser.html#cb201-39" aria-hidden="true" tabindex="-1"></a>                                       <span class="st">&quot;F1&quot;</span>)],</span>
<span id="cb201-40"><a href="multiuser.html#cb201-40" aria-hidden="true" tabindex="-1"></a>                      <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb201-41"><a href="multiuser.html#cb201-41" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb201-42"><a href="multiuser.html#cb201-42" aria-hidden="true" tabindex="-1"></a>  recalls <span class="ot">&lt;-</span> <span class="fu">c</span>(recalls, metrics[<span class="st">&quot;Recall&quot;</span>])</span>
<span id="cb201-43"><a href="multiuser.html#cb201-43" aria-hidden="true" tabindex="-1"></a>  precisions <span class="ot">&lt;-</span> <span class="fu">c</span>(precisions, metrics[<span class="st">&quot;Precision&quot;</span>])</span>
<span id="cb201-44"><a href="multiuser.html#cb201-44" aria-hidden="true" tabindex="-1"></a>} <span class="co"># end of users iteration.</span></span></code></pre></div>
<p>We iterated through each user and performed the leave-one-out-validation for each, independently of the others and stored their results. We now compute the average performance across all users.</p>
<div class="sourceCode" id="cb202"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb202-1"><a href="multiuser.html#cb202-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Print average performance across users.</span></span>
<span id="cb202-2"><a href="multiuser.html#cb202-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb202-3"><a href="multiuser.html#cb202-3" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(accuracies)</span>
<span id="cb202-4"><a href="multiuser.html#cb202-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] 0.943114</span></span>
<span id="cb202-5"><a href="multiuser.html#cb202-5" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(recalls)</span>
<span id="cb202-6"><a href="multiuser.html#cb202-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] 0.9425154</span></span>
<span id="cb202-7"><a href="multiuser.html#cb202-7" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(precisions)</span>
<span id="cb202-8"><a href="multiuser.html#cb202-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] 0.9500772</span></span></code></pre></div>
<p>This time, the average accuracy was <span class="math inline">\(94.3\%\)</span> which is higher than the accuracy achieved with the mixed model and the user-independent model. The average recall and precision were also higher compared to the other types of models. The reason is because each model was targeted to a particular user.</p>
<p><strong>When should a user-dependent model be used to validate a system?</strong></p>
<ol style="list-style-type: decimal">
<li>When the model will be trained only using data from the target user.</li>
</ol>
<p>In general, user-dependent models have the best accuracy. The disadvantage is that they require training data from the target user and for some applications, collecting training data can be very difficult and expensive.</p>
<p>Can we have a system that has the best of both worlds between user-dependent and user-independent models? That is, a model that is as accurate as a user-dependent model but requires small quantities of training data from the target user. The answer is <em>yes</em>, and this is covered in the next section (<em>User-adaptive Models</em>).</p>
</div>
<div id="user-adaptive-models" class="section level2" number="9.4">
<h2><span class="header-section-number">9.4</span> User-adaptive Models</h2>
<p>We have already talked about some of the limitations of <strong>user-dependent</strong> and <strong>user-independent</strong> models. On one hand, user-dependent models require training data from the target user. In many situations, collecting training data is difficult. On the other hand, user-independent models do not need data from the target user but are less accurate. To overcome those limitations, models that evolve over time as more information is available can be built. One can start with a user-independent model and as more data becomes available from the target user, the model is updated accordingly. In this case, there is no need for a user to wait before using the system and as new feedback is available, the model gets better and better by learning the specific patterns of the user.</p>
<p>In this section, I will explain how a technique called <strong>transfer learning</strong> can be used to build an <strong>adaptive model</strong> that updates itself as new training data is available. First, in the following subsection the idea of transfer learning is introduced and next, the method is used to build an adaptive model for activity recognition.</p>
<div id="transfer-learning" class="section level3" number="9.4.1">
<h3><span class="header-section-number">9.4.1</span> Transfer Learning</h3>
<p>In machine learning, <strong>transfer learning</strong> refers to the idea of using the knowledge gained when solving a problem to solve a different one. The new problem can be similar but also very unrelated. For example, a model trained to detect smiles from images could also be used to predict gender (of course with some fine-tuning). In humans, learning is a lifelong process in which many tasks are interrelated. When faced with a new problem, we tend to find solutions that have worked in the past for similar problems. However, in machine learning most of the time models are trained from scratch for every new problem. For many tasks, training a model from scratch is very time consuming and requires a lot of effort, especially during the data collection and labeling phase.</p>
<p>The idea of transfer learning dates back to 1991 <span class="citation">(<a href="#ref-pratt1991" role="doc-biblioref">Pratt et al. 1991</a>)</span> but with the advent of <em>deep learning</em> and in particular, with Convolutional Neural Networks (see chapter <a href="deeplearning.html#deeplearning">8</a>), it has gained popularity because it has proven to be a valuable tool when solving challenging problems. In 2014 a CNN architecture called VGG16 was proposed by <span class="citation"><a href="#ref-simonyan2014" role="doc-biblioref">Simonyan and Zisserman</a> (<a href="#ref-simonyan2014" role="doc-biblioref">2014</a>)</span> and won the ILSVR image recognition competition. This CNN was trained with more than <span class="math inline">\(1\)</span> million images to recognize <span class="math inline">\(1000\)</span> categories. It consists of several convolution layers, max pooling operations, and fully connected layers. In total, the network has <span class="math inline">\(\approx 138\)</span> million parameters and it took some weeks to train.</p>
<p>What if you wanted to add a new category to the <span class="math inline">\(1000\)</span> labels? Or maybe, you only want to focus on a subset of the categories? With transfer learning you can take advantage of a network that has already been trained and adapt it to your particular problem. In the case of <em>deep learning</em>, the approach consists of ‘freezing’ the first layers of a network and only retraining (updating) the last layers for the particular problem. During training, the frozen layers’ parameters will not change and the unfrozen ones are updated as usual during the gradient descent procedure. As discussed in chapter <a href="deeplearning.html#deeplearning">8</a>, the first layers can act as feature extractors and be reused. With this approach, you can easily retrain a VGG16 network in an average computer and within a reasonable time. In fact, Keras already provides interfaces to common pre-trained models that you can reuse.</p>
<p>In the following section we will use this idea to build a <strong>user-adaptive model</strong> for activity recognition using transfer learning.</p>
</div>
<div id="a-user-adaptive-model-for-activity-recognition" class="section level3" number="9.4.2">
<h3><span class="header-section-number">9.4.2</span> A User-adaptive Model for Activity Recognition</h3>

<div class="rmdfolder">
<code>keras/adaptive_cnn.R</code>
</div>
<p>For this example, we will use the <em>SMARTPHONE ACTIVITIES</em> dataset <strong>encoded as images </strong>. In chapter <a href="representations.html#representations">7</a> (section: Images) I showed how timeseries data can be represented as an image. That section presented an example of how accelerometer data can be represented as an RBG color image where each channel corresponds to one of the acceleration axes (<em>x</em>, <em>y</em>, <em>z</em>). We will use the file <code>images.txt</code> that already contains the activities in image format. The procedure of converting the raw data into this format was explained in chapter <a href="representations.html#representations">7</a> and the corresponding code is in the script <code>timeseries_to_images.R</code>. Since the input data are images, we will use a Convolutional Neural Network (see chapter <a href="deeplearning.html#deeplearning">8</a>).</p>
<p>The main objective will be to build an adaptive model with a small amount of training data from the target user. We will first build a <strong>user-independent model</strong>. That is, we will select one of the users as the <em>target user</em>. We train the user-independent model with data from the remaining users (excluding the target user). Then, we will apply transfer learning to adapt the model to the target user.</p>
<p>The target user’s data will be split into a test set and an <strong>adaptive set</strong>. The test set will be used to evaluate the performance of the model and the adaptive set will be used to fine-tune the model. The adaptive set is used to simulate that we have obtained new data from the target user.</p>
<p>The complete code is in the script <code>keras/adaptive_cnn.R</code>. First, we start by reading the images file. Each row corresponds to one activity. The last two columns are the <code>userid</code> and the <code>class</code>. The first <span class="math inline">\(300\)</span> columns correspond to the image pixels. Each image has a size of <span class="math inline">\(10 \times 10 \times 3\)</span> (height, width, depth).</p>
<div class="sourceCode" id="cb203"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb203-1"><a href="multiuser.html#cb203-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Path to smartphone activities in image format.</span></span>
<span id="cb203-2"><a href="multiuser.html#cb203-2" aria-hidden="true" tabindex="-1"></a>filepath <span class="ot">&lt;-</span> <span class="fu">file.path</span>(datasets_path,</span>
<span id="cb203-3"><a href="multiuser.html#cb203-3" aria-hidden="true" tabindex="-1"></a>                      <span class="st">&quot;smartphone_activities&quot;</span>,</span>
<span id="cb203-4"><a href="multiuser.html#cb203-4" aria-hidden="true" tabindex="-1"></a>                      <span class="st">&quot;images.txt&quot;</span>)</span>
<span id="cb203-5"><a href="multiuser.html#cb203-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb203-6"><a href="multiuser.html#cb203-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Read data.</span></span>
<span id="cb203-7"><a href="multiuser.html#cb203-7" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(filepath, <span class="at">stringsAsFactors =</span> F)</span>
<span id="cb203-8"><a href="multiuser.html#cb203-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb203-9"><a href="multiuser.html#cb203-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Shuffle rows.</span></span>
<span id="cb203-10"><a href="multiuser.html#cb203-10" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1234</span>)</span>
<span id="cb203-11"><a href="multiuser.html#cb203-11" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> df[<span class="fu">sample</span>(<span class="fu">nrow</span>(df)),]</span></code></pre></div>
<p>The rows happen to be ordered by user and activity, so we shuffle them to ensure that the model is not biased toward the last users and activities.</p>
<p>Since we will train a CNN using Keras, we need the classes to be in integer format. The following code is used to append a new column <code>intlabel</code> to the database. This new column contains the classes as integers. We also create a variable <code>mapping</code> to keep track of the mapping between integers and the actual labels. By printing the <code>mapping</code> variable we see that for example, the <em>‘Walking’</em> label has a corresponding integer value of <span class="math inline">\(0\)</span>, <em>‘Downstairs’</em> <span class="math inline">\(1\)</span>, and so on.</p>
<div class="sourceCode" id="cb204"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb204-1"><a href="multiuser.html#cb204-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Convert labels to integers starting at 0. ##</span></span>
<span id="cb204-2"><a href="multiuser.html#cb204-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb204-3"><a href="multiuser.html#cb204-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the unique labels.</span></span>
<span id="cb204-4"><a href="multiuser.html#cb204-4" aria-hidden="true" tabindex="-1"></a>labels <span class="ot">&lt;-</span> <span class="fu">unique</span>(df<span class="sc">$</span>label)</span>
<span id="cb204-5"><a href="multiuser.html#cb204-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb204-6"><a href="multiuser.html#cb204-6" aria-hidden="true" tabindex="-1"></a>mapping <span class="ot">&lt;-</span> <span class="dv">0</span><span class="sc">:</span>(<span class="fu">length</span>(labels) <span class="sc">-</span> <span class="dv">1</span>)</span>
<span id="cb204-7"><a href="multiuser.html#cb204-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb204-8"><a href="multiuser.html#cb204-8" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(mapping) <span class="ot">&lt;-</span> labels</span>
<span id="cb204-9"><a href="multiuser.html#cb204-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb204-10"><a href="multiuser.html#cb204-10" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(mapping)</span>
<span id="cb204-11"><a href="multiuser.html#cb204-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;    Walking Downstairs    Jogging   Standing   Upstairs    Sitting </span></span>
<span id="cb204-12"><a href="multiuser.html#cb204-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;         0          1          2          3          4          5 </span></span>
<span id="cb204-13"><a href="multiuser.html#cb204-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb204-14"><a href="multiuser.html#cb204-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Append labels as integers at the end of data frame.</span></span>
<span id="cb204-15"><a href="multiuser.html#cb204-15" aria-hidden="true" tabindex="-1"></a>df<span class="sc">$</span>intlabel <span class="ot">&lt;-</span> mapping[df<span class="sc">$</span>label]</span></code></pre></div>
<p>Now we store the unique users’ ids in the <code>users</code> variable. After printing the variable’s values, notice that there are <span class="math inline">\(19\)</span> distinct users in this database. The original database has more users but we only kept those that performed all the activities. Then, we select one of the users to act as the <em>target user</em>. I will just select one of them at random (turned out to be user <span class="math inline">\(24\)</span>). Feel free to select another user if you want.</p>
<div class="sourceCode" id="cb205"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb205-1"><a href="multiuser.html#cb205-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the unique user ids.</span></span>
<span id="cb205-2"><a href="multiuser.html#cb205-2" aria-hidden="true" tabindex="-1"></a>users <span class="ot">&lt;-</span> <span class="fu">unique</span>(df<span class="sc">$</span>userid)</span>
<span id="cb205-3"><a href="multiuser.html#cb205-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb205-4"><a href="multiuser.html#cb205-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Print all user ids.</span></span>
<span id="cb205-5"><a href="multiuser.html#cb205-5" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(users)</span>
<span id="cb205-6"><a href="multiuser.html#cb205-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] 29 20 18  8 32 27  3 36 34  5  7 12  6 21 24 31 13 33 19</span></span>
<span id="cb205-7"><a href="multiuser.html#cb205-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb205-8"><a href="multiuser.html#cb205-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Choose one user at random to be the target user.</span></span>
<span id="cb205-9"><a href="multiuser.html#cb205-9" aria-hidden="true" tabindex="-1"></a>targetUser <span class="ot">&lt;-</span> <span class="fu">sample</span>(users, <span class="dv">1</span>)</span></code></pre></div>
<p>Next, we split the data into two sets. The first set <code>trainset</code> contains the data from all users but <strong>excluding the target user</strong>. We create two variables: <code>train.y</code> and <code>train.x</code>. The first one has the labels as integers and the second one has the actual image pixels (features). The second set <code>target.data</code> contains data only from the target user.</p>
<div class="sourceCode" id="cb206"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb206-1"><a href="multiuser.html#cb206-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Split into train and target user sets.</span></span>
<span id="cb206-2"><a href="multiuser.html#cb206-2" aria-hidden="true" tabindex="-1"></a><span class="co"># The train set includes data from all users excluding targetUser.</span></span>
<span id="cb206-3"><a href="multiuser.html#cb206-3" aria-hidden="true" tabindex="-1"></a>trainset <span class="ot">&lt;-</span> df[df<span class="sc">$</span>userid <span class="sc">!=</span> targetUser,]</span>
<span id="cb206-4"><a href="multiuser.html#cb206-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb206-5"><a href="multiuser.html#cb206-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Save train labels in a separate variable.</span></span>
<span id="cb206-6"><a href="multiuser.html#cb206-6" aria-hidden="true" tabindex="-1"></a>train.y <span class="ot">&lt;-</span> trainset<span class="sc">$</span>intlabel</span>
<span id="cb206-7"><a href="multiuser.html#cb206-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb206-8"><a href="multiuser.html#cb206-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Save train pixels in a separate variable.</span></span>
<span id="cb206-9"><a href="multiuser.html#cb206-9" aria-hidden="true" tabindex="-1"></a>train.x <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(trainset[,<span class="sc">-</span><span class="fu">c</span>(<span class="dv">301</span>,<span class="dv">302</span>,<span class="dv">303</span>)])</span>
<span id="cb206-10"><a href="multiuser.html#cb206-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb206-11"><a href="multiuser.html#cb206-11" aria-hidden="true" tabindex="-1"></a><span class="co"># This contains all data from the target user.</span></span>
<span id="cb206-12"><a href="multiuser.html#cb206-12" aria-hidden="true" tabindex="-1"></a>target.data <span class="ot">&lt;-</span> df[df<span class="sc">$</span>userid <span class="sc">==</span> targetUser,]</span></code></pre></div>
<p>Then, we split the target’s user data into <span class="math inline">\(50\%\)</span> test data and <span class="math inline">\(50\%\)</span> adaptive data (code omitted here) so that we end up with the following <span class="math inline">\(4\)</span> variables:</p>
<ol style="list-style-type: decimal">
<li><code>target.adaptive.y</code> Integer labels for the adaptive data of the target user.</li>
<li><code>target.adaptive.x</code> Pixels of the adaptive data of the target user.</li>
<li><code>target.test.y</code> Integer labels for the test data of the target user.</li>
<li><code>target.test.x</code> Pixels of the test data of the target user.</li>
</ol>
<p>We also need to normalize the data and reshape it into the actual image format since in their current form, the pixels are stored into <span class="math inline">\(1\)</span>-dimensional arrays. We learn the normalization parameters only from the train set and then, use the <code>normalize.reshape()</code> function (defined in the same script file) to perform the actual normalization and formatting.</p>
<div class="sourceCode" id="cb207"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb207-1"><a href="multiuser.html#cb207-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Learn min and max values from train set for normalization.</span></span>
<span id="cb207-2"><a href="multiuser.html#cb207-2" aria-hidden="true" tabindex="-1"></a>maxv <span class="ot">&lt;-</span> <span class="fu">max</span>(train.x)</span>
<span id="cb207-3"><a href="multiuser.html#cb207-3" aria-hidden="true" tabindex="-1"></a>minv <span class="ot">&lt;-</span> <span class="fu">min</span>(train.x)</span>
<span id="cb207-4"><a href="multiuser.html#cb207-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb207-5"><a href="multiuser.html#cb207-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Normalize and reshape. May take some minutes.</span></span>
<span id="cb207-6"><a href="multiuser.html#cb207-6" aria-hidden="true" tabindex="-1"></a>train.x <span class="ot">&lt;-</span> <span class="fu">normalize.reshape</span>(train.x, minv, maxv)</span>
<span id="cb207-7"><a href="multiuser.html#cb207-7" aria-hidden="true" tabindex="-1"></a>target.adaptive.x <span class="ot">&lt;-</span> <span class="fu">normalize.reshape</span>(target.adaptive.x, minv, maxv)</span>
<span id="cb207-8"><a href="multiuser.html#cb207-8" aria-hidden="true" tabindex="-1"></a>target.test.x <span class="ot">&lt;-</span> <span class="fu">normalize.reshape</span>(target.test.x, minv, maxv)</span></code></pre></div>
<p>Let’s inspect how the structure of the final datasets looks like.</p>
<div class="sourceCode" id="cb208"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb208-1"><a href="multiuser.html#cb208-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(train.x)</span>
<span id="cb208-2"><a href="multiuser.html#cb208-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] 6399   10   10    3</span></span>
<span id="cb208-3"><a href="multiuser.html#cb208-3" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(target.adaptive.x)</span>
<span id="cb208-4"><a href="multiuser.html#cb208-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] 124  10  10   3</span></span>
<span id="cb208-5"><a href="multiuser.html#cb208-5" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(target.test.x)</span>
<span id="cb208-6"><a href="multiuser.html#cb208-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] 124  10  10   3</span></span></code></pre></div>
<p>Here, we see that the train set has <span class="math inline">\(6399\)</span> instances (images). The adaptive and test sets both have <span class="math inline">\(124\)</span> instances.</p>
<p>Now that we are done with the preprocessing, it is time to build the CNN model! This one will be the initial user-independent model and is trained with all the train data <code>train.x</code>, <code>train.y</code>.</p>
<div class="sourceCode" id="cb209"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb209-1"><a href="multiuser.html#cb209-1" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> <span class="fu">keras_model_sequential</span>()</span>
<span id="cb209-2"><a href="multiuser.html#cb209-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb209-3"><a href="multiuser.html#cb209-3" aria-hidden="true" tabindex="-1"></a>model <span class="sc">%&gt;%</span></span>
<span id="cb209-4"><a href="multiuser.html#cb209-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_conv_2d</span>(<span class="at">name =</span> <span class="st">&quot;conv1&quot;</span>,</span>
<span id="cb209-5"><a href="multiuser.html#cb209-5" aria-hidden="true" tabindex="-1"></a>                <span class="at">filters =</span> <span class="dv">8</span>,</span>
<span id="cb209-6"><a href="multiuser.html#cb209-6" aria-hidden="true" tabindex="-1"></a>                <span class="at">kernel_size =</span> <span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">2</span>),</span>
<span id="cb209-7"><a href="multiuser.html#cb209-7" aria-hidden="true" tabindex="-1"></a>                <span class="at">activation =</span> <span class="st">&#39;relu&#39;</span>,</span>
<span id="cb209-8"><a href="multiuser.html#cb209-8" aria-hidden="true" tabindex="-1"></a>                <span class="at">input_shape =</span> <span class="fu">c</span>(<span class="dv">10</span>,<span class="dv">10</span>,<span class="dv">3</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb209-9"><a href="multiuser.html#cb209-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_conv_2d</span>(<span class="at">name =</span> <span class="st">&quot;conv2&quot;</span>,</span>
<span id="cb209-10"><a href="multiuser.html#cb209-10" aria-hidden="true" tabindex="-1"></a>                <span class="at">filters =</span> <span class="dv">16</span>,</span>
<span id="cb209-11"><a href="multiuser.html#cb209-11" aria-hidden="true" tabindex="-1"></a>                <span class="at">kernel_size =</span> <span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">2</span>),</span>
<span id="cb209-12"><a href="multiuser.html#cb209-12" aria-hidden="true" tabindex="-1"></a>                <span class="at">activation =</span> <span class="st">&#39;relu&#39;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb209-13"><a href="multiuser.html#cb209-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_max_pooling_2d</span>(<span class="at">pool_size =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">2</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb209-14"><a href="multiuser.html#cb209-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_flatten</span>() <span class="sc">%&gt;%</span></span>
<span id="cb209-15"><a href="multiuser.html#cb209-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_dense</span>(<span class="at">name =</span> <span class="st">&quot;hidden1&quot;</span>, <span class="at">units =</span> <span class="dv">32</span>,</span>
<span id="cb209-16"><a href="multiuser.html#cb209-16" aria-hidden="true" tabindex="-1"></a>              <span class="at">activation =</span> <span class="st">&#39;relu&#39;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb209-17"><a href="multiuser.html#cb209-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_dropout</span>(<span class="fl">0.25</span>) <span class="sc">%&gt;%</span></span>
<span id="cb209-18"><a href="multiuser.html#cb209-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_dense</span>(<span class="at">units =</span> <span class="dv">6</span>, <span class="at">activation =</span> <span class="st">&#39;softmax&#39;</span>)</span></code></pre></div>
<p>This CNN has two convolutional layers followed by a max pooling operation, a fully connected layer, and an output layer. One important thing to note is that <strong>we have specified a name for each layer</strong> with the <code>name</code> parameter. For example, the first convolution’s name is <code>conv1</code>, the second one is <code>conv2</code>, and the fully connected layer was named <code>hidden1</code>. Those names must be unique because they will be used to select specific layers to freeze and unfreeze.</p>
<p>If we print the model’s summary (Figure <a href="multiuser.html#fig:adaptSummary1">9.5</a>) we see that in total it has <span class="math inline">\(9,054\)</span> <strong>trainable parameters</strong> and <span class="math inline">\(0\)</span> <strong>non-trainable parameters</strong>. This means that all the parameters of the network will be updated during the gradient descent procedure, as usual.</p>
<div class="sourceCode" id="cb210"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb210-1"><a href="multiuser.html#cb210-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Print summary.</span></span>
<span id="cb210-2"><a href="multiuser.html#cb210-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model)</span></code></pre></div>
<div class="figure" style="text-align: center"><span id="fig:adaptSummary1"></span>
<img src="images/adaptive_summary.png" alt="Summary of initial user-independent model." width="90%" />
<p class="caption">
FIGURE 9.5: Summary of initial user-independent model.
</p>
</div>
<p>The next code will compile the model and initiate the training phase.</p>
<div class="sourceCode" id="cb211"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb211-1"><a href="multiuser.html#cb211-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Compile model.</span></span>
<span id="cb211-2"><a href="multiuser.html#cb211-2" aria-hidden="true" tabindex="-1"></a>model <span class="sc">%&gt;%</span> <span class="fu">compile</span>(</span>
<span id="cb211-3"><a href="multiuser.html#cb211-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">loss =</span> <span class="st">&#39;sparse_categorical_crossentropy&#39;</span>,</span>
<span id="cb211-4"><a href="multiuser.html#cb211-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">optimizer =</span> <span class="fu">optimizer_sgd</span>(<span class="at">lr =</span> <span class="fl">0.01</span>),</span>
<span id="cb211-5"><a href="multiuser.html#cb211-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">metrics =</span> <span class="fu">c</span>(<span class="st">&quot;accuracy&quot;</span>)</span>
<span id="cb211-6"><a href="multiuser.html#cb211-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb211-7"><a href="multiuser.html#cb211-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-8"><a href="multiuser.html#cb211-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit the user-independent model.</span></span>
<span id="cb211-9"><a href="multiuser.html#cb211-9" aria-hidden="true" tabindex="-1"></a>history <span class="ot">&lt;-</span> model <span class="sc">%&gt;%</span> <span class="fu">fit</span>(</span>
<span id="cb211-10"><a href="multiuser.html#cb211-10" aria-hidden="true" tabindex="-1"></a>  train.x, train.y,</span>
<span id="cb211-11"><a href="multiuser.html#cb211-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">epochs =</span> <span class="dv">50</span>,</span>
<span id="cb211-12"><a href="multiuser.html#cb211-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">batch_size =</span> <span class="dv">8</span>,</span>
<span id="cb211-13"><a href="multiuser.html#cb211-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">validation_split =</span> <span class="fl">0.15</span>,</span>
<span id="cb211-14"><a href="multiuser.html#cb211-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">verbose =</span> <span class="dv">1</span>,</span>
<span id="cb211-15"><a href="multiuser.html#cb211-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">view_metrics =</span> <span class="cn">TRUE</span></span>
<span id="cb211-16"><a href="multiuser.html#cb211-16" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb211-17"><a href="multiuser.html#cb211-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-18"><a href="multiuser.html#cb211-18" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(history)</span></code></pre></div>
<div class="figure" style="text-align: center"><span id="fig:adaptLoss1"></span>
<img src="images/adapt_loss1.png" alt="Loss and accuracy plot of the initial user-independent model." width="90%" />
<p class="caption">
FIGURE 9.6: Loss and accuracy plot of the initial user-independent model.
</p>
</div>

<div class="rmdinfo">
Note that this time the loss was defined as <code>loss = 'sparse_categorical_crossentropy'</code> instead of the usual <code>loss = 'categorical_crossentropy'</code>. Here, the <code>sparse_</code> suffix was added. You may have noted that in this example we did not one-hot encode the labels but they were only transformed into integers. By adding the <code>sparse_</code> suffix we are telling Keras that our labels are not one-hot-encoded but encoded as integers starting at <span class="math inline">\(0\)</span>. It will then perform the one-hot encoding for us. This is a little trick that saved us some time.
</div>
<p>Figure <a href="multiuser.html#fig:adaptLoss1">9.6</a> shows a plot of the loss and accuracy during training. Then, we save the model so we can load it later. Let’s also estimate the model’s performance on the target user test set.</p>
<div class="sourceCode" id="cb212"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb212-1"><a href="multiuser.html#cb212-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Save model.</span></span>
<span id="cb212-2"><a href="multiuser.html#cb212-2" aria-hidden="true" tabindex="-1"></a><span class="fu">save_model_hdf5</span>(model, <span class="st">&quot;user-independent.hdf5&quot;</span>)</span>
<span id="cb212-3"><a href="multiuser.html#cb212-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb212-4"><a href="multiuser.html#cb212-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute performance (accuracy) on the target user test set.</span></span>
<span id="cb212-5"><a href="multiuser.html#cb212-5" aria-hidden="true" tabindex="-1"></a>model <span class="sc">%&gt;%</span> <span class="fu">evaluate</span>(target.test.x, target.test.y)</span>
<span id="cb212-6"><a href="multiuser.html#cb212-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;      loss  accuracy </span></span>
<span id="cb212-7"><a href="multiuser.html#cb212-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 1.4837638 0.6048387</span></span></code></pre></div>
<p>The overall <em>accuracy</em> of this user-independent model when tested on the target user was <span class="math inline">\(60.4\%\)</span> (quite low). Now, we can apply transfer learning and see if the model does better. We will ‘freeze’ the first convolution layer and only update the second convolution layer and the remaining fully connected layers using the target user-adaptive data. The following code loads the previously trained user-independent model. Then all the CNN’s weights are frozen using the <code>freeze_weights()</code> function. The <code>from</code> parameter specifies the first layer (inclusive) from which the parameters are to be frozen. Here, it is set to <span class="math inline">\(1\)</span> so all parameters in the network are ‘frozen.’ Then, we use the <code>unfreeze_weights()</code> function to specify from which layer (inclusive) the parameters should be unfrozen. In this case, we want to retrain from the second convolutional layer so we set it to <code>conv2</code> which is how we named this layer earlier.</p>
<div class="sourceCode" id="cb213"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb213-1"><a href="multiuser.html#cb213-1" aria-hidden="true" tabindex="-1"></a>adaptive.model <span class="ot">&lt;-</span> <span class="fu">load_model_hdf5</span>(<span class="st">&quot;user-independent.hdf5&quot;</span>)</span>
<span id="cb213-2"><a href="multiuser.html#cb213-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb213-3"><a href="multiuser.html#cb213-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Freeze all layers.</span></span>
<span id="cb213-4"><a href="multiuser.html#cb213-4" aria-hidden="true" tabindex="-1"></a><span class="fu">freeze_weights</span>(adaptive.model, <span class="at">from =</span> <span class="dv">1</span>)</span>
<span id="cb213-5"><a href="multiuser.html#cb213-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb213-6"><a href="multiuser.html#cb213-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Unfreeze layers from conv2.</span></span>
<span id="cb213-7"><a href="multiuser.html#cb213-7" aria-hidden="true" tabindex="-1"></a><span class="fu">unfreeze_weights</span>(adaptive.model, <span class="at">from =</span> <span class="st">&quot;conv2&quot;</span>)</span></code></pre></div>
<p>After those changes, we need to compile the model so the modifications take effect.</p>
<div class="sourceCode" id="cb214"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb214-1"><a href="multiuser.html#cb214-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Compile model. We need to compile after freezing/unfreezing weights.</span></span>
<span id="cb214-2"><a href="multiuser.html#cb214-2" aria-hidden="true" tabindex="-1"></a>adaptive.model <span class="sc">%&gt;%</span> <span class="fu">compile</span>(</span>
<span id="cb214-3"><a href="multiuser.html#cb214-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">loss =</span> <span class="st">&#39;sparse_categorical_crossentropy&#39;</span>,</span>
<span id="cb214-4"><a href="multiuser.html#cb214-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">optimizer =</span> <span class="fu">optimizer_sgd</span>(<span class="at">lr =</span> <span class="fl">0.01</span>),</span>
<span id="cb214-5"><a href="multiuser.html#cb214-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">metrics =</span> <span class="fu">c</span>(<span class="st">&quot;accuracy&quot;</span>)</span>
<span id="cb214-6"><a href="multiuser.html#cb214-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb214-7"><a href="multiuser.html#cb214-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb214-8"><a href="multiuser.html#cb214-8" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(adaptive.model)</span></code></pre></div>
<div class="figure" style="text-align: center"><span id="fig:adaptSummary2"></span>
<img src="images/adaptive_summary2.png" alt="Summary of user-independent model after freezing first convolutional layer." width="90%" />
<p class="caption">
FIGURE 9.7: Summary of user-independent model after freezing first convolutional layer.
</p>
</div>
<p>After printing the summary (Figure <a href="multiuser.html#fig:adaptSummary2">9.7</a>), note that the number of <strong>trainable and non-trainable parameters</strong> has changed. Now, the non-trainable parameters are <span class="math inline">\(104\)</span> (before they were <span class="math inline">\(0\)</span>). These <span class="math inline">\(104\)</span> parameters correspond to the first convolutional layer but this time they will not be updated during the gradient descent training phase.</p>
<p>The following code will retrain the model using the adaptive data but keeping the first convolutional layer fixed.</p>
<div class="sourceCode" id="cb215"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb215-1"><a href="multiuser.html#cb215-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Update model with adaptive data.</span></span>
<span id="cb215-2"><a href="multiuser.html#cb215-2" aria-hidden="true" tabindex="-1"></a>history <span class="ot">&lt;-</span> adaptive.model <span class="sc">%&gt;%</span> <span class="fu">fit</span>(</span>
<span id="cb215-3"><a href="multiuser.html#cb215-3" aria-hidden="true" tabindex="-1"></a>  target.adaptive.x, target.adaptive.y,</span>
<span id="cb215-4"><a href="multiuser.html#cb215-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">epochs =</span> <span class="dv">50</span>,</span>
<span id="cb215-5"><a href="multiuser.html#cb215-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">batch_size =</span> <span class="dv">8</span>,</span>
<span id="cb215-6"><a href="multiuser.html#cb215-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">validation_split =</span> <span class="dv">0</span>,</span>
<span id="cb215-7"><a href="multiuser.html#cb215-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">verbose =</span> <span class="dv">1</span>,</span>
<span id="cb215-8"><a href="multiuser.html#cb215-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">view_metrics =</span> <span class="cn">TRUE</span></span>
<span id="cb215-9"><a href="multiuser.html#cb215-9" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>

<div class="rmdcaution">
Note that this time the <code>validation_split</code> was set to <span class="math inline">\(0\)</span>. This is because the target user data set is very small so there is not enough data to use as validation set. One possible approach to overcome this is to leave a percentage of users out when building the train set for the user-independent model. Then, use those left-out users to find which are the most appropriate layers to keep frozen. Once you are happy with the results, evaluate the model on the target user.
</div>
<div class="sourceCode" id="cb216"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb216-1"><a href="multiuser.html#cb216-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute performance (accuracy) on the target user test set.</span></span>
<span id="cb216-2"><a href="multiuser.html#cb216-2" aria-hidden="true" tabindex="-1"></a>adaptive.model <span class="sc">%&gt;%</span> <span class="fu">evaluate</span>(target.test.x, target.test.y)</span>
<span id="cb216-3"><a href="multiuser.html#cb216-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;      loss  accuracy </span></span>
<span id="cb216-4"><a href="multiuser.html#cb216-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 0.5173104 0.8548387</span></span></code></pre></div>
<p>If we evaluate the adaptive model’s performance on the target’s user test set, the accuracy is <span class="math inline">\(85.4\%\)</span> which is a considerable increase! (<span class="math inline">\(\approx 25\%\)</span> increase).</p>
<p>At this point, you may be wondering whether this accuracy increase was due to the fact that the model was trained for an additional <span class="math inline">\(50\)</span> epochs. To validate this, we can re-train the initial user-independent model for <span class="math inline">\(50\)</span> more epochs.</p>
<div class="sourceCode" id="cb217"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb217-1"><a href="multiuser.html#cb217-1" aria-hidden="true" tabindex="-1"></a>retrained_model <span class="ot">&lt;-</span> <span class="fu">load_model_hdf5</span>(<span class="st">&quot;user-independent.hdf5&quot;</span>)</span>
<span id="cb217-2"><a href="multiuser.html#cb217-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb217-3"><a href="multiuser.html#cb217-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit the user-independent model for 50 more epochs.</span></span>
<span id="cb217-4"><a href="multiuser.html#cb217-4" aria-hidden="true" tabindex="-1"></a>history <span class="ot">&lt;-</span> retrained_model <span class="sc">%&gt;%</span> <span class="fu">fit</span>(</span>
<span id="cb217-5"><a href="multiuser.html#cb217-5" aria-hidden="true" tabindex="-1"></a>  train.x, train.y,</span>
<span id="cb217-6"><a href="multiuser.html#cb217-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">epochs =</span> <span class="dv">50</span>,</span>
<span id="cb217-7"><a href="multiuser.html#cb217-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">batch_size =</span> <span class="dv">8</span>,</span>
<span id="cb217-8"><a href="multiuser.html#cb217-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">validation_split =</span> <span class="fl">0.15</span>,</span>
<span id="cb217-9"><a href="multiuser.html#cb217-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">verbose =</span> <span class="dv">1</span>,</span>
<span id="cb217-10"><a href="multiuser.html#cb217-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">view_metrics =</span> <span class="cn">TRUE</span></span>
<span id="cb217-11"><a href="multiuser.html#cb217-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb217-12"><a href="multiuser.html#cb217-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb217-13"><a href="multiuser.html#cb217-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute performance (accuracy) on the target user test set.</span></span>
<span id="cb217-14"><a href="multiuser.html#cb217-14" aria-hidden="true" tabindex="-1"></a>retrained_model <span class="sc">%&gt;%</span> <span class="fu">evaluate</span>(target.test.x, target.test.y)</span>
<span id="cb217-15"><a href="multiuser.html#cb217-15" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;      loss  accuracy </span></span>
<span id="cb217-16"><a href="multiuser.html#cb217-16" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 1.3033305 0.7096774</span></span></code></pre></div>
<p>After re-training the user-independent model for <span class="math inline">\(50\)</span> more epochs, its <em>accuracy</em> increased to <span class="math inline">\(70.9\%\)</span>. On the other hand, the adaptive model was trained with fewer data and produced a much better result (<span class="math inline">\(85.4\%\)</span>) with only <span class="math inline">\(124\)</span> instances as compared to the user-independent model (<span class="math inline">\(\approx 5440\)</span> instances). That is, the <span class="math inline">\(6399\)</span> instances minus <span class="math inline">\(15\%\)</span> used as the validation set. These results highlight one of the main advantages of transfer learning which is a reduction in the needed amount of train data.</p>
</div>
</div>
<div id="SummaryMultiUser" class="section level2" number="9.5">
<h2><span class="header-section-number">9.5</span> Summary</h2>
<p>Many real-life scenarios involve multi-user settings. That is, the system heavily depends on the specific behavior of a given target user. This chapter covered different types of models that can be used to evaluate the performance of a system in such a scenario.</p>
<ul>
<li>A <strong>multi-user setting</strong> is one in which its results depend heavily on the target user.</li>
<li>Inter/Intra -user variance are the differences between users and within the same users, respectively.</li>
<li><strong>Mixed models</strong> are trained without considering unique users (user ids) information.</li>
<li><strong>User-independent models</strong> are trained without including data from the <em>target user</em>.</li>
<li><strong>User-dependent models</strong> are trained only with data from the <em>target user</em>.</li>
<li><strong>User-adaptive models</strong> can be adapted to a particular <em>target user</em> as more data is available.</li>
<li><strong>Transfer learning</strong> is a method that can be used to adapt a model to a particular user without requiring big quantities of data.</li>
</ul>
<p><img src="images/comic_opera.png" width="100%" style="display: block; margin: auto;" />
</p>

</div>
</div>
<h3>References</h3>
<div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-rmatlab" class="csl-entry">
Bengtsson, Henrik. 2018. <em>R.matlab: Read and Write MAT Files and Call MATLAB from Within r</em>. <a href="https://CRAN.R-project.org/package=R.matlab">https://CRAN.R-project.org/package=R.matlab</a>.
</div>
<div id="ref-chen2015utd" class="csl-entry">
Chen, Chen, Roozbeh Jafari, and Nasser Kehtarnavaz. 2015. <span>“UTD-MHAD: A Multimodal Dataset for Human Action Recognition Utilizing a Depth Camera and a Wearable Inertial Sensor.”</span> In <em>2015 IEEE International Conference on Image Processing (ICIP)</em>, 168–72. IEEE.
</div>
<div id="ref-pratt1991" class="csl-entry">
Pratt, Lorien Y, Jack Mostow, Candace A Kamm, and Ace A Kamm. 1991. <span>“Direct Transfer of Learned Information Among Neural Networks.”</span> In <em>Aaai</em>, 91:584–89.
</div>
<div id="ref-simonyan2014" class="csl-entry">
Simonyan, Karen, and Andrew Zisserman. 2014. <span>“Very Deep Convolutional Networks for Large-Scale Image Recognition.”</span> <em>arXiv Preprint arXiv:1409.1556</em>.
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="deeplearning.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="abnormalbehaviors.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook/js/app.min.js"></script>
<script src="libs/gitbook/js/lunr.js"></script>
<script src="libs/gitbook/js/clipboard.min.js"></script>
<script src="libs/gitbook/js/plugin-search.js"></script>
<script src="libs/gitbook/js/plugin-sharing.js"></script>
<script src="libs/gitbook/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook/js/plugin-bookdown.js"></script>
<script src="libs/gitbook/js/jquery.highlight.js"></script>
<script src="libs/gitbook/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"toc": {
"collapse": "none"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
